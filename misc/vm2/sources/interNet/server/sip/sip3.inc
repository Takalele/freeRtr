Procedure releq2upper;
Label f1,f2,f3;
Var
  buf:array[1..4*1024] of byte;
  ps,siz:LongInt;

Function isMore:Boolean;
Begin;
isMore:=(ps<siz);
End;

Function getLine:String;
Label f1,f2;
Var
  a:String;
  ab:array[0..1] of byte absolute a;
  ab0:byte absolute a;
  i,o:LongInt;
Begin;
ab0:=0;
f1:
inc(ps);
if (ps>siz) then goto f2;
i:=buf[ps];
if (i=32) and (ab[ab0]=32) then goto f1;
if not (i in [13,10]) then begin;
  inc(ab0);
  ab[ab0]:=i;
  goto f1;
  end;
if (buf[ps+1]=23-i) then inc(ps);
if (buf[ps+1]=32) then goto f1;
f2:
getLine:=a;
End;

Function parseSDP(var adr:OneTCPaddressRecord;var prt:LongInt;var cod:LongInt):Boolean;
Label f1;
Var
  saw:LongInt;
  a,b:String;
  i,o:LongInt;

Procedure addCodec;
Begin;
if (i=8) then cod:=cod or 1;
End;

Begin;
parseSDP:=True;
saw:=0;
cod:=0;
f1:
if not isMore then begin;
  if (saw<>3) then exit;
  if (cod=0) then exit;
  parseSDP:=False;
  exit;
  end;
b:=getLine;
i:=pos('=',b);
a:=kicsi(xLevesz(copy(b,1,i-1)));
b:=kicsi(xLevesz(copy(b,i+1,666)));
if (a='c') then begin;
  if (getWord(b)<>'in') then goto f1;
  if (copy(getWord(b),1,2)<>'ip') then goto f1;
  if string2ipAddr(getWord(b),a) then goto f1;
  move(a,adr,sizeof(adr));
  saw:=saw or 1;
  goto f1;
  end;
if (a='m') then begin;
  if (getWord(b)<>'audio') then goto f1;
  i:=BVal(getWord(b));
  if (i=0) then exit;
  prt:=i;
  if (getWord(b)<>'rtp/avp') then goto f1;
  while (b<>'') do begin;
    a:=getWord(b);
    i:=BVal(a);
    if (BStr(i)<>a) then continue;
    addCodec;
    end;
  saw:=saw or 2;
  goto f1;
  end;
if (a='a') then begin;
  a:=getWord(b);
  i:=pos(':',a);
  if (copy(a,1,i-1)<>'rtpmap') then goto f1;
  a:=copy(a,i+1,666);
  i:=BVal(a);
  if (BStr(i)<>a) then goto f1;
  addCodec;
  goto f1;
  end;

goto f1;
End;

Var
  cmd,cid,src,trg,via,csq,cnt:String;
  adr:OneTCPaddressRecord;
  prt:LongInt;
  i,o,p:LongInt;
  a,b:String;
  ab:array[0..1] of byte absolute a;
  ab0:byte absolute a;
  con:OneConnectionRecord;
Begin;
siz:=sizeof(buf);
if UDPreceivePacket(localPipe,adr,prt,buf,siz) then exit;
if (siz<2) then exit;
for i:=1 to 5 do buf[siz+i]:=$61;
for i:=1 to siz do if (buf[i] in [0,7,9,255]) then buf[i]:=32;
{$ifdef debug}
dumpOneMessage('got from '+ipAddr2string(adr)+' '+BStr(prt),buf,siz);
{$endif}
ps:=0;
cmd:=getLine;
kicserel('  ',' ',cmd);
cid:='';
src:='';
trg:='';
via:='';
csq:='';
cnt:='';
f1:
b:=getLine;
if (b='') then goto f2;
kicserel('  ',' ',b);
i:=pos(':',b);
a:=kicsi(xLevesz(copy(b,1,i-1)));
b:=xLevesz(copy(b,i+1,666));
if (a='from') then src:=b;
if (a='to') then trg:=b;
if (a='via') then via:=b;
if (a='cseq') then csq:=b;
if (a='call-id') then cid:=b;
if (a='contact') then cnt:=b;
goto f1;
f2:
fillchar(con,sizeof(con),0);
con.Scid:=cid;
con.Ssrc:=src;
con.Strg:=trg;
con.Svia:=via;
con.Sseq:=csq;
con.addr:=adr;
con.port:=prt;
a:=kicsi(getWord(cmd));
if (a='register') then begin;
  WriteLn('got register from '+ipAddr2string(adr)+' '+BStr(prt));
  con.Svia:=con.Svia+';received='+ipAddr2string(adr);
  con.Strg:=con.Strg+';tag=reg'+BStr(currentTime);
  sendOneSIPmessage('SIP/2.0 200 ok',cnt,'',con);
  exit;
  end;
if (a='invite') then begin;
  WriteLn('got invite from '+ipAddr2string(adr)+' '+BStr(prt));
  i:=FindOneConnectionByCID(cid);
  if (i<>0) then begin;
    con:=ConnectionDat^[i];
    con.Svia:=via;
    con.Sseq:=csq;
    WriteLn('resending trying to '+ipAddr2string(con.addr)+' '+BStr(con.port));
    sendOneSIPmessage('SIP/2.0 100 trying','','',con);
    exit;
    end;
  con.clld:=1;
  con.Strg:=con.Strg+';tag=call'+BStr(currentTime);
  con.stat:=1;
  con.time:=currentTime;
  if parseSDP(con.rtpA,con.rtpP,con.codc) then begin;
    WriteLn('failed to get sdp parameters');
    exit;
    end;
  a:=getPhoneNumber(cnt);
  a:=copy(a,pos('@',a)+1,666);
  b:='';
  if (copy(a,1,1)='[') then begin;
    i:=pos(']',a);
    b:=copy(b,2,i-2);
    a:=copy(a,i+1,666);
    end;
  i:=pos(':',a);
  if (i<1) then i:=666;
  b:=b+copy(a,1,i-1);
  a:=copy(a,i+1,666);
  i:=BVal(a);
  if (i<1) then i:=5060;
  if not string2ipAddr(b,adr) then begin;
    con.addr:=adr;
    con.port:=i;
    end;
  if ResizeMem(ConnectionNum+1) then begin;
    WriteLn('failed to allocate mrmory!');
    exit;
    end;
  ConnectionDat^[ConnectionNum]:=con;
  WriteLn('sending trying to '+ipAddr2string(con.addr)+' '+BStr(con.port));
  sendOneSIPmessage('SIP/2.0 100 trying','','',con);
  exit;
  end;
if (a='cancel') or (a='bye') then begin;
  WriteLn('got bye from '+ipAddr2string(adr)+' '+BStr(prt));
  i:=FindOneConnectionByCID(cid);
  if (i<>0) then begin;
    ConnectionDat^[i].stat:=999;
    con:=ConnectionDat^[i];
    con.Svia:=via;
    con.Sseq:=csq;
    con.Ssrc:=src;
    con.Strg:=trg;
    end;
  WriteLn('sending ok to '+ipAddr2string(con.addr)+' '+BStr(con.port));
  sendOneSIPmessage('SIP/2.0 200 ok','','',con);
  exit;
  end;
if (a='ack') then begin;
  WriteLn('got ack from '+ipAddr2string(adr)+' '+BStr(prt));
  i:=FindOneConnectionByCID(cid);
  if (i=0) then goto f3;
  con:=ConnectionDat^[i];
  if (con.stat=4) then con.stat:=0;
  generateSDPdata(con);
  con.time:=currentTime;
  ConnectionDat^[i]:=con;
  exit;
  end;
if (copy(a,1,4)<>'sip/') then begin;
  WriteLn('got unknown command from '+ipAddr2string(adr)+' '+BStr(prt));
  WriteLn('sending notallowed to '+ipAddr2string(con.addr)+' '+BStr(con.port));
  sendOneSIPmessage('SIP/2.0 405 method not allowed','','',con);
  exit;
  end;
a:=kicsi(getWord(cmd));
if (copy(a,1,1)='1') then begin;
  WriteLn('got temporary from '+ipAddr2string(adr)+' '+BStr(prt));
  p:=FindOneConnectionByCID(cid);
  if (p=0) then begin;
    f3:
    WriteLn('got unknown call id, sending bye to '+ipAddr2string(adr)+' '+BStr(prt));
    con.Sseq:=BStr(currentTime)+' BYE';
    sendOneSIPmessage('BYE sip:'+getPhoneNumber(con.Strg)+' SIP/2.0','','',con);
    exit;
    end;
  con:=ConnectionDat^[p];
  if (con.stat=7) then con.stat:=8;
  con.Strg:=trg;
  con.time:=currentTime;
  ConnectionDat^[p]:=con;
  exit;
  end;
if (copy(a,1,1)='2') then begin;
  WriteLn('got positive from '+ipAddr2string(adr)+' '+BStr(prt));
  b:=getWord(csq);
  a:=kicsi(getWord(csq));
  p:=FindOneConnectionByCID(cid);
  if (p=0) then begin;
    if (a='invite') then goto f3;
    exit;
    end;
  if (a='bye') then begin;
    ConnectionDat^[p].stat:=999;
    exit;
    end;
  if (a<>'invite') then exit;
  con:=ConnectionDat^[p];
  con.Sseq:=b+' ACK';
  if not (con.stat in [7,8]) then begin;
    WriteLn('resending ack to '+ipAddr2string(con.addr)+' '+BStr(con.port));
    sendOneSIPmessage('ACK sip:'+getPhoneNumber(con.Strg)+' SIP/2.0',#13,'',con);
    exit;
    end;
  o:=con.rtpP;
  if parseSDP(con.rtpA,con.rtpP,con.codc) then begin;
    WriteLn('failed to get sdp parameters');
    ConnectionDat^[p].stat:=5;
    exit;
    end;
  pipeLineClose(con.strm);
  for i:=1 to 3 do relequish;
  con.strm:=0;
  if RTPopenConnection(con.strm,32768,con.rtpA,con.rtpP) then begin;
    WriteLn('failed to open rtp port');
    ConnectionDat^[p].stat:=5;
    exit;
    end;
  if (o<>con.rtpP) then begin;
    WriteLn('different rtp port opened');
    ConnectionDat^[p].stat:=5;
    exit;
    end;
  con.Strg:=trg;
  con.time:=currentTime;
  con.stat:=0;
  generateSDPdata(con);
  ConnectionDat^[p]:=con;
  WriteLn('sending ack to '+ipAddr2string(con.addr)+' '+BStr(con.port));
  sendOneSIPmessage('ACK sip:'+getPhoneNumber(con.Strg)+' SIP/2.0',#13,'',con);
  i:=$01010101;
  pipeLineSend(con.pipe,i,1);
  exit;
  end;
if (copy(a,1,1)='3') or (copy(a,1,1)='4') or (copy(a,1,1)='5') or (copy(a,1,1)='6') then begin;
  WriteLn('got error from '+ipAddr2string(adr)+' '+BStr(prt));
  p:=FindOneConnectionByCID(cid);
  if (p=0) then exit;
  if (ConnectionDat^[p].stat in [7,8]) then begin;
    i:=0;
    pipeLineSend(con.pipe,i,1);
    end;
  ConnectionDat^[p].stat:=999;
  exit;
  end;

WriteLn('got unknown status from '+ipAddr2string(adr)+' '+BStr(prt));
End;
