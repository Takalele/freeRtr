Procedure doPipeForward(pipe,conn:LongInt);
Label f1,f2,f3;
Var
  buf:array[1..32*1024] of byte;
  rxSiz:LongInt;
  i,o,p,q:LongInt;
Begin;
rxSiz:=-1;
f1:
relequish;
pipeLineStats(conn,p,o,q);
if (rxSiz<0) then begin;
  if (o<2) then goto f3;
  i:=2;
  if (pipeLineRecv(conn,buf,i)<>0) then i:=0;
  if (i<>2) then goto f2;
  rxSiz:=ReadWordMSB(buf);
  if (rxSiz>0) and (rxSiz<=sizeof(buf)) then goto f1;
  WriteLn('got invalid packet size from remote!');
  exit;
  end else begin;
  if (o<rxSiz) then goto f3;
  pipeLineStats(pipe,p,o,i);
  if (i<rxSiz) then goto f2;
  i:=rxSiz;
  if (pipeLineRecv(conn,buf,i)<>0) then i:=0;
  if (i<>rxSiz) then goto f2;
  pipeLineSend(pipe,buf,rxSiz);
  rxSiz:=-1;
  goto f1;
  end;
f3:
if (p=0) then begin;
  WriteLn('remote closed connection!');
  exit;
  end;
f2:
pipeLineStats(pipe,p,o,i);
if (o<1) then begin;
  if (p<>0) then goto f1;
  WriteLn('process closed connection!');
  exit;
  end;
dec(q,8);
if (q<32) then goto f1;
if (pipeLineRecv(pipe,buf,q)<>0) then q:=0;
if (q<1) then goto f1;
WriteWordMSB(i,q);
pipeLineSend(conn,i,2);
pipeLineSend(conn,buf,q);
goto f1;
End;
