Function doUpper:Boolean;
Label f1,f2,f3,f4,f5;
Var
  buf:array[1..4*1024] of byte;
  pip:LongInt;
  i,o,p:LongInt;
  a,b:String;
Begin;
doUpper:=False;
f1:
if (pipeLineGetIncoming(pip)<>0) then goto f3;
pipeLineStats(pip,p,i,o);
BugOS_ProcessName(p,buf,i,i,o);
if (o and $40=0) then goto f2;
i:=128;
if (pipeLineRecv(pip,b[1],i)<>0) then i:=0;
b[0]:=chr(i);
a:=kicsi(copy(b,1,8));
b:=copy(b,9,255);
if ena4ip then begin;
  if (a='arpadd--') then begin;
    a:='ok';
    goto f2;
    end;
  if (a='arpread-') then begin;
    a:='arpdata'#0#0#0#0;
    goto f2;
    end;
  if (a='param---') then begin;
    a:='param';
    b[0]:=#4;
    move(loc4ip[13],b[1],4);a:=a+b;
    move(rem4ip[13],b[1],4);a:=a+b;
    move(msk4ip[13],b[1],4);a:=a+b;
    goto f2;
    end;
  if (a='data----') and (up4pipe=0) then begin;
    a:='data';
    pipeLineSend(pip,a[1],length(a));
    up4pipe:=pip;
    goto f1;
    end;
  end;
if ena6ip then begin;
  if (a='adradd--') then begin;
    a:='ok';
    goto f2;
    end;
  if (a='adrread-') then begin;
    a:='adrdata'#0#0#0#0;
    goto f2;
    end;
  if (a='param6--') then begin;
    a:='param6'#0#0#0;
    fillchar(b,sizeof(b),0);
    b[0]:=#16;
    b[1]:=#$fe;
    b[2]:=#$80;
    move(addrLoc,b[17-addrSiz],addrSiz);a:=a+b;
    move(loc6ip[1],b[1],16);a:=a+b;
    move(rem6ip[1],b[1],16);a:=a+b;
    move(msk6ip[1],b[1],16);a:=a+b;
    goto f2;
    end;
  if (a='data6---') and (up6pipe=0) then begin;
    a:='data6';
    pipeLineSend(pip,a[1],length(a));
    up6pipe:=pip;
    goto f1;
    end;
  end;

a:='error';
f2:
pipeLineSend(pip,a[1],length(a));
pipeLineClose(pip);
goto f1;

f3: {ipv4}
if (up4pipe=0) then goto f4;
p:=sizeof(buf);
if (pipeLineRecv(up4pipe,buf,p)<>0) then p:=0;
if (p<1) then begin;
  pipeLineStats(up4pipe,o,i,i);
  if (o<>0) then goto f4;
  pipeLineClose(up4pipe);
  up4pipe:=0;
  goto f4;
  end;
dec(p,4);
move(buf[5],buf[addrSiz+typeSiz],p);
if (typeSiz>2) then begin;
  WriteWordMSB(buf[addrSiz+1],$800);
  inc(p,2);
  end;
move(addrAll,buf,addrSiz);
inc(p,addrSiz);
pipeLineSend(devPipe,buf,p);
doUpper:=True;

f4: {ipv6}
if (up6pipe=0) then goto f5;
p:=sizeof(buf);
if (pipeLineRecv(up6pipe,buf,p)<>0) then p:=0;
if (p<1) then begin;
  pipeLineStats(up6pipe,o,i,i);
  if (o<>0) then goto f5;
  pipeLineClose(up6pipe);
  up6pipe:=0;
  goto f5;
  end;
move(buf,i,sizeof(i));
if (i<>0) then goto f5;
dec(p,20);
move(buf[21],buf[addrSiz+typeSiz],p);
if (typeSiz>2) then begin;
  WriteWordMSB(buf[addrSiz+1],$86dd);
  inc(p,2);
  end;
move(addrAll,buf,addrSiz);
inc(p,addrSiz);
pipeLineSend(devPipe,buf,p);
doUpper:=True;

f5:
End;
