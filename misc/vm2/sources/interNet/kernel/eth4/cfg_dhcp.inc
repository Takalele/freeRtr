Procedure Configure_dhcp;
Label f0,f1,f2,f3,f4;
Var
  buf:array[1..1024] of byte;
  bootp:OneBOOTPheaderRecord absolute buf;
  transId:LongInt;
  adr,adrS:OneEtherAddrRec;
  i,o,p,q,r,s,t:LongInt;
  retry:LongInt;
  a,b:String;
Begin;
transId:=0;
f0:
confgMod:=1;
localNet:=0;
gatwyNet:=0;
ntmskNet:=0;
bootpNet:=$ffffffff;
dnsServs:='';
leaseTimeValue:=0;

retry:=0;
f1:
inc(retry);
if (retry>64) then immErr('too much try!');
inc(transId);
fillchar(buf,sizeof(buf),0);
bootp.op:=Op_BOOTP_req;
bootp.htype:=1;
bootp.hlen:=sizeof(localEth);
bootp.xid:=transId;
bootp.secs:=transId;
move(localEth,bootp.chadr,sizeof(localEth));
WriteLongMSB(bootp.magic,dhcpMagicCookie);
i:=0;
bootpAddOption(bootp,i,53,chr(Op_DHCP_discover));
move(localEth,a[1],sizeof(localEth));a[0]:=Chr(sizeof(localEth));
bootpAddOption(bootp,i,61,#1+a);
bootpAddOption(bootp,i,255,'');
sendUDPpacket(broadEth,localNet,bootpNet,UDPport_BOOTPc,UDPport_BOOTPs,sizeof(bootp)+60,bootp);
BugOS_KernelUptime(i,t,o);
WriteLn('DHCP sent discover');
f2:
relequish;
if (getTimePast(t)>5) then goto f1;
receiveUDPpacket(adr,p,o,i,q,s,buf);
if (s<sizeof(bootp)) then goto f2;
if (q<>UDPport_BOOTPc) then goto f2;
if (bootp.op<>Op_BOOTP_rep) then goto f2;
if (ReadLongMSB(bootp.magic)<>dhcpMagicCookie) then goto f2;
bootpNet:=p;
gatwyNet:=p;
adrS:=adr;
localNet:=bootp.yiadr;
if (bootp.giadr<>0) then gatwyNet:=bootp.giadr;
if (bootp.siadr<>0) then bootpNet:=bootp.siadr;
parseBootpOptions(buf,i,a);
if (i<>Op_DHCP_offer) then goto f2;
WriteLn('DHCP got offer from '+convEtherAddr(adr));

retry:=0;
f3:
inc(retry);
if (retry>3) then exit;
fillchar(buf,sizeof(buf),0);
bootp.op:=Op_BOOTP_req;
bootp.htype:=1;
bootp.hlen:=sizeof(localEth);
bootp.xid:=transId;
bootp.secs:=transId;
move(localEth,bootp.chadr,sizeof(localEth));
WriteLongMSB(bootp.magic,dhcpMagicCookie);
i:=0;
bootpAddOption(bootp,i,53,chr(Op_DHCP_request));
move(localEth,b[1],sizeof(localEth));b[0]:=Chr(sizeof(localEth));
bootpAddOption(bootp,i,61,#1+b);
move(localNet,b[1],sizeof(localNet));b[0]:=Chr(sizeof(localNet));
bootpAddOption(bootp,i,50,b);
move(leaseTimeValue,b,sizeof(leaseTimeValue));b[0]:=chr(leaseTimeValue);
bootpAddOption(bootp,i,51,b);
bootpAddOption(bootp,i,54,a);
bootpAddOption(bootp,i,55,#1#3#6);
bootpAddOption(bootp,i,255,'');
o:=0;
sendUDPpacket(broadEth,o,broadNet,UDPport_BOOTPc,UDPport_BOOTPs,sizeof(bootp)+60,bootp);
BugOS_KernelUptime(i,t,o);
WriteLn('DHCP sent request');
f4:
relequish;
if (getTimePast(t)>5) then goto f3;
receiveUDPpacket(adr,p,o,i,q,s,buf);
if (s<sizeof(bootp)) then goto f4;
if (q<>UDPport_BOOTPc) then goto f4;
if (bootp.op<>Op_BOOTP_rep) then goto f4;
if (ReadLongMSB(bootp.magic)<>dhcpMagicCookie) then goto f4;
parseBootpOptions(buf,i,a);
if (i<>Op_DHCP_ack) then goto f4;
WriteLn('DHCP got ack from '+convEtherAddr(adr));

End;
