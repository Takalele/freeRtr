Procedure gotNewIncomingConnection(pipe:LongInt);
Label f1;
Var
  i,o,p:LongInt;
  a:String;
Begin;
for i:=1 to ConnectionNum do if (ConnectionDat[i].pipe=0) then goto f1;
pipeLineClose(pipe);
exit;
f1:
ConnectionDat[i].pipe:=pipe;
a:=ipAddr2string(ConnectionDat[i].addr);
WriteLn('upper with '+a+' logged in!');
a:='gre with '+a;
BugOS_MyProcessInfo(i,o,p);
i:=i xor p xor o;
p:=((i shr 24) xor (i shr 16) xor (i shr 8) xor i) and $ff;
a:='12341234'#0#0#0#0#0#0#0#0+chr(p)+#255+a+#0;
i:=1;move(i,a[1],sizeof(i));
i:=1400;move(i,a[5],sizeof(i));
pipeLineSend(pipe,a[1],length(a));
End;



Procedure relequish2connection(var con:OneConnectionRecord);
Var
  buf:array[1..4096] of byte;
  b:array[1..32] of byte;
  i,o,p,q:LongInt;
  w:Word;
Begin;
if (con.pipe=0) then exit;
p:=sizeof(buf);
if (pipeLineRecv(con.pipe,buf,p)<>0) then p:=0;
if (p<1) then begin;
  pipeLineStats(con.pipe,p,o,o);
  if (p<>0) then exit;
  pipeLineClose(con.pipe);
  con.pipe:=0;
  exit;
  end;
inc(con.seq);
dec(p,3);
b[1]:=con.mode;
b[2]:=0;
move(buf[2],b[3],sizeof(w));
q:=4;
if (con.mode and $80<>0) then begin;
  b[q+3]:=0;
  b[q+4]:=0;
  inc(q,4);
  end;
if (con.mode and $20<>0) then begin;
  move(con.key,b[q+1],sizeof(i));
  inc(q,4);
  end;
if (con.mode and $10<>0) then begin;
  WriteLongMSB(b[q+1],con.seq);
  inc(q,4);
  end;
if (con.mode and $80<>0) then begin;
  w:=CalculateSum(buf[4],p);
  move(w,b[5],sizeof(w));
  w:=not CalculateSum(b,q);
  move(w,b[5],sizeof(w));
  end;
move(buf[4],buf[q+1],p);
move(b,buf,q);
UDPsendPacket(pipe,con.addr,0,buf,p+q);
End;



Procedure gotOnePacket(var buffer;siz:LongInt;var addr);
Var
  buf:array[1..1] of byte absolute buffer;
  i,o,p,q:Longint;
Begin;
p:=findOnePeerAddr(addr);
if (p<1) then begin;
  WriteLn('got packet from unknown host: '+ipAddr2string(addr));
  exit;
  end;
i:=buf[1];
if (i and $4f<>0) then begin;
  WriteLn('got unknown flags from '+ipAddr2string(addr));
  exit;
  end;
if (buf[2]<>0) then begin;
  WriteLn('got bad version from '+ipAddr2string(addr));
  exit;
  end;
ConnectionDat[p].mode:=i;
q:=4;
if (i and $80<>0) then begin;
  if (CalculateSum(buf,siz)<>$ffff) then begin;
    WriteLn('got bad checksum from '+ipAddr2string(addr));
    exit;
    end;
  inc(q,4);
  end;
if (i and $20<>0) then begin;
  move(buf[q+1],ConnectionDat[p].key,sizeof(i));
  inc(q,4);
  end;
if (i and $10<>0) then begin;
  inc(q,4);
  end;
o:=ConnectionDat[p].pipe;
if (o=0) then begin;
  WriteLn('got packet for closed upper from '+ipAddr2string(addr));
  exit;
  end;
dec(siz,q);
move(buf[3],buf[2],sizeof(word));
move(buf[q+1],buf[4],siz);
buf[1]:=11;
pipeLineSend(o,buf,siz+3);
End;
