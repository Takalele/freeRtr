{$heap 63k}
{$stack 3k}
{$sysinc system.inc}
{$sysinc filesys.inc}
{$sysinc param.inc}
{$sysinc bugos.inc}
{$sysinc pipeline.inc}

Const
  cosWave:array[0..440] of Integer=(
    16384,16382,16377,16369,16357,16342,16324,16303,16278,16249,16218,
    16183,16145,16104,16059,16011,15960,15906,15848,15787,15723,15656,
    15586,15512,15435,15356,15273,15187,15097,15005,14910,14812,14710,
    14606,14499,14389,14276,14160,14041,13919,13795,13667,13537,13404,
    13269,13130,12989,12846,12700,12551,12400,12246,12089,11931,11769,
    11606,11440,11272,11101,10928,10753,10576,10397,10215,10032,9846,9659,
    9469,9278,9084,8889,8692,8493,8293,8091,7887,7682,7475,7266,7056,6845,
    6632,6418,6202,5986,5768,5549,5329,5107,4885,4662,4437,4212,3986,3759,
    3532,3304,3075,2845,2615,2384,2153,1921,1689,1457,1224,991,758,525,
    292,58,-175,-408,-642,-875,-1108,-1341,-1573,-1805,-2037,-2269,-2500,
    -2730,-2960,-3189,-3418,-3646,-3873,-4099,-4325,-4550,-4773,-4996,
    -5218,-5439,-5658,-5877,-6094,-6310,-6525,-6739,-6951,-7161,-7371,
    -7578,-7784,-7989,-8192,-8393,-8593,-8791,-8987,-9181,-9374,-9564,
    -9753,-9939,-10124,-10306,-10487,-10665,-10841,-11015,-11187,-11356,
    -11523,-11688,-11850,-12010,-12168,-12323,-12476,-12626,-12773,-12918,
    -13060,-13200,-13337,-13471,-13603,-13731,-13857,-13980,-14101,-14218,
    -14333,-14444,-14553,-14659,-14761,-14861,-14958,-15052,-15142,-15230,
    -15315,-15396,-15474,-15549,-15621,-15690,-15756,-15818,-15877,-15933,
    -15986,-16036,-16082,-16125,-16165,-16201,-16234,-16264,-16291,-16314,
    -16334,-16350,-16364,-16374,-16380,-16384,-16384,-16380,-16374,-16364,
    -16350,-16334,-16314,-16291,-16264,-16234,-16201,-16165,-16125,-16082,
    -16036,-15986,-15933,-15877,-15818,-15756,-15690,-15621,-15549,-15474,
    -15396,-15315,-15230,-15142,-15052,-14958,-14861,-14761,-14659,-14553,
    -14444,-14333,-14218,-14101,-13980,-13857,-13731,-13603,-13471,-13337,
    -13200,-13060,-12918,-12773,-12626,-12476,-12323,-12168,-12010,-11850,
    -11688,-11523,-11356,-11187,-11015,-10841,-10665,-10487,-10306,-10124,
    -9939,-9753,-9564,-9374,-9181,-8987,-8791,-8593,-8393,-8192,-7989,
    -7784,-7578,-7371,-7161,-6951,-6739,-6525,-6310,-6094,-5877,-5658,
    -5439,-5218,-4996,-4773,-4550,-4325,-4099,-3873,-3646,-3418,-3189,
    -2960,-2730,-2500,-2269,-2037,-1805,-1573,-1341,-1108,-875,-642,-408,
    -175,58,292,525,758,991,1224,1457,1689,1921,2153,2384,2615,2845,3075,
    3304,3532,3759,3986,4212,4437,4662,4885,5107,5329,5549,5768,5986,6202,
    6418,6632,6845,7056,7266,7475,7682,7887,8091,8293,8493,8692,8889,9084,
    9278,9469,9659,9846,10032,10215,10397,10576,10753,10928,11101,11272,
    11440,11606,11769,11931,12089,12246,12400,12551,12700,12846,12989,
    13130,13269,13404,13537,13667,13795,13919,14041,14160,14276,14389,
    14499,14606,14710,14812,14910,15005,15097,15187,15273,15356,15435,
    15512,15586,15656,15723,15787,15848,15906,15960,16011,16059,16104,
    16145,16183,16218,16249,16278,16303,16324,16342,16357,16369,16377,
    16382);
Var pipe,size,freq:LongInt;

Procedure immErr(a:String);
Begin;
WriteLn(a);
Halt(1);
End;

Function exchange(Var buf;siz:LongInt):LongInt;
Label f1;
Var i,o:LongInt;
Begin;
pipeLineSend(pipe,buf,siz);
f1:
relequish;
siz:=1024*32;
if (pipeLineRecv(pipe,buf,siz)<>0) then siz:=0;
if (siz<1) then begin;
  pipeLineStats(pipe,o,i,i);
  if (o=0) then immErr('sound device closed connection!');
  goto f1;
  end;
exchange:=siz;
End;

Procedure makePart(prt:LongInt;var buffer);
Var
  buf:array[1..1] of integer absolute buffer;
  i,o,p:LongInt;
Begin;
p:=0;
for o:=0 to size-1 do begin;
  i:=(prt*size+o) mod 44100;            {within one second}
  i:=((i*freq) div 100) mod 441;        {within the sample}
  i:=cosWave[i];
  inc(p);buf[p]:=i;
  inc(p);buf[p]:=i;
  end;
End;


Label f1,f2;
Var
  buf:array[1..1024*16] of byte;
  i,o,p:LongInt;
  a:String;
BEGIN;
WriteLn('digital beeper v1.0, done by Mc at '#%date' '#%time'.');
if (paramCount<1) then immErr('using: db.code <process>');
a:=paramStr(1);
i:=BVal(a);
if (i=0) then i:=BugOS_findProcNam(a);
if (i=0) then immErr('process not found!');

if (pipeLineCreate(pipe,i,65536,true)<>0) then immErr('error opening pipeline!');
buf[1]:=5;
exchange(buf,1);
move(buf,size,sizeof(size));
size:=size shr 2;

pipeLineBegListen;
BugOS_SignDaemoning;

p:=0;
f1:
pipeLineClose(p);
while (pipeLineGetIncoming(p)<>0) do relequish;
f2:
i:=sizeof(buf);
if (pipeLineRecv(p,buf,i)<>0) then i:=0;
if (i<1) then begin;
  pipeLineStats(p,o,i,i);
  if (o=0) then goto f1;
  relequish;
  goto f2;
  end;
move(buf[1],freq,sizeof(freq));
move(buf[5],o,sizeof(o));
o:=(o*(44100 div size)) div 1000;
for i:=0 to (o and $ffff) do begin;
  makePart(i,buf[2]);
  buf[1]:=6;
  exchange(buf,(size shl 2)+1);
  end;
goto f2;
END.