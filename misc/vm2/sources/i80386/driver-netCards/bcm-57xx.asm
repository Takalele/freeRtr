;-------------------------------
nic_name db 'Broadcom netXtreme',0              ;thanks kt@lnx for hw...
nic_date db %date,' ',%time,0
nic_reqParam equ 100b
nic_addrSize equ 6
nic_maxPack equ 1502
nic_minPack equ 48
;-------------------------------

;-------------------------------
bcm_RxQueue equ 32              ;number of receive buffers...
bcm_TxQueue equ 2               ;number of transmit buffers...
bcm_RxMax equ 512               ;number of receive descriptors...
bcm_TxMax equ 512               ;number of transmit descriptors...
bcm_buf1 equ 0ac00h             ;48k: receiver ring...
bcm_buf2 equ 0a400h             ;2k: transmit ring...
bcm_buf3 equ 04400h             ;16k: receiver descriptors...
bcm_buf4 equ 08400h             ;8k: transmit descriptors...
bcm_buf5 equ 00400h             ;16k: receiver status...
bcm_buf6 equ 00000h             ;1k: status of nic...
;-------------------------------

;-------------------------------
bcm_RxBroad equ 000h            ;db: bit0=broadcasts, bit1=multicasts...
bcm_RxNext equ 004h             ;dd: next descriptor to test...
bcm_TxNext equ 008h             ;dd: next transmit to use...
bcm_TxNxQu equ 00ch             ;dd: next transmit buffer to use...
bcm_phyMem equ 010h             ;dd: memory physical offset...
bcm_mapMem equ 014h             ;dd: memory mapped offset...
bcm_mapped equ 018h             ;dd: mapped memory offset...
;-------------------------------


;-------------------------------
proc nic_present
mov ecx,20000h
call dword system_allocCont
or ebx,ebx
jnz byte nic_present_err
mov def:[bcm_mapMem],edi
mov def:[bcm_phyMem],eax
mov eax,def:[dataSeg_parMem]
mov ecx,10000h
call dword system_mapMem
or ebx,ebx
jnz byte nic_present_err
sub eax,def:[dataSeg_parMem]
neg eax
add eax,edi
mov def:[bcm_mapped],eax
;sram mac address...
mov dx,8c14h
call dword bcm_read
mov ecx,eax
shr ecx,16
cmp ecx,484bh
je byte nic_present_j1
nic_present_err:
stc
retnd
nic_present_j1:
mov edi,dataSeg_parAdr
xchg al,ah
stosw ptr32
mov dx,8c18h
call dword bcm_read
xchg al,ah
rol eax,16
xchg al,ah
stosd ptr32
mov edi,dataSeg_parBrd
sub eax,eax
dec eax
mov def:[bcm_rxBroad],al
stosd ptr32
stosd ptr32
call dword nic_restart
clc
retnd
endp
;-------------------------------

;-------------------------------
proc bcm_read
;in:  dx-register offset...
;out: eax-value read...
push edx
movzx edx,dx
add edx,def:[bcm_mapped]
mov eax,def:[edx]
pop edx
retnd
endp
;-------------------------------

;-------------------------------
proc bcm_write
;in: dx-register offset...
;    eax-value to write...
push edx
movzx edx,dx
add edx,def:[bcm_mapped]
mov def:[edx],eax
push eax
mov eax,def:[edx]
pop eax
pop edx
clc
retnd
endp
;-------------------------------


;-------------------------------
proc nic_restart
mov esi,offset nic_restart_d0
call dword nic_restart_j1
nic_restart_j0:
call dword timer_relequish
mov dx,8b50h
call dword bcm_read
cmp eax,0b49a89abh
jne byte nic_restart_j0
mov esi,def:[dataSeg_tckSec]
call dword timer_delay
;build status page...
mov edi,bcm_buf6
add edi,def:[bcm_mapMem]
mov ecx,18h
sub eax,eax
mov def:[bcm_RxNext],eax
mov def:[bcm_TxNext],eax
mov def:[bcm_TxNxQu],eax
rep
  stosd ptr32
;build receive descriptors...
mov ecx,bcm_RxMax
mov edi,bcm_buf3
add edi,def:[bcm_mapMem]
sub ebp,ebp
sub esi,esi
nic_restart_j4:
sub eax,eax                     ;addr.hi...
stosd ptr32
imul eax,ebp,600h               ;addr.lo...
add eax,bcm_buf1
add eax,def:[bcm_phyMem]
stosd ptr32
mov eax,600h                    ;idx-len...
stosd ptr32
mov eax,4                       ;type-flags...
stosd ptr32
sub eax,eax
stosd ptr32                     ;tcp/ip-chksum...
stosd ptr32                     ;err-vlan...
stosd ptr32                     ;reserved...
mov eax,esi                     ;opaque...
or eax,10000h
stosd ptr32
inc esi
mov eax,bcm_RxQueue
dec eax
inc ebp
and ebp,eax
loopd nic_restart_j4
;build transmit descriptors...
mov ecx,bcm_TxMax
shl ecx,2
mov edi,bcm_buf4
add edi,def:[bcm_mapMem]
sub eax,eax
rep
  stosd ptr32
;build receive status...
mov ecx,bcm_RxMax
shl ecx,3
mov edi,bcm_buf5
add edi,def:[bcm_mapMem]
sub eax,eax
rep
  stosd ptr32
mov esi,offset nic_restart_d1
call dword nic_restart_j1
mov esi,offset nic_restart_d2
call dword nic_restart_j1
mov esi,offset nic_restart_d3
call dword nic_restart_j1
;set status address...
mov dx,3c38h
mov eax,bcm_buf6
call dword nic_restart_j3
;receive descriptors...
mov dx,2450h
mov eax,bcm_buf3
call dword nic_restart_j3
;transmit descriptors...
mov dx,8100h
mov eax,bcm_buf4
call dword nic_restart_j3
;receiver status...
mov dx,8200h
mov eax,bcm_buf5
call dword nic_restart_j3
;set mac address...
mov dx,410h
mov ecx,4
nic_restart_j5:
mov esi,dataSeg_parAdr
sub eax,eax
lodsw ptr32
xchg al,ah
call dword bcm_write
add dx,4
lodsd ptr32
xchg al,ah
rol eax,16
xchg al,ah
call dword bcm_write
add dx,4
loopd nic_restart_j5
mov esi,def:[dataSeg_tckSec]
add esi,esi
call dword timer_delay
clc
retnd
nic_restart_d0:
dd 7020h,00000002h
dd 6804h,20000000h
dd 6804h,24000001h
dd 4000h,00000002h
dd 6800h,00120034h
dd 0400h,00000000h
dd -1,-1                        ;end of list...
nic_restart_d1:
dd 6800h,34h                    ;setup grc to lsb mode...
dd 4,106h
dd 68,9ah
dd 0000006ch,076180000h
dd 00007c00h,0af85002fh
dd 00000074h,000000000h
dd 0000006ch,076180000h
dd 00006800h,004130034h
dd 00006804h,03c089082h
dd 00004410h,000000000h
dd 00004414h,000000010h
dd 00004418h,000000060h
dd 00004434h,000000005h
dd 00004438h,00000000ah
dd 00004400h,000000006h
dd 00002c18h,000000019h
dd 00002450h,000000000h
dd 0000245ch,000006000h
dd 00002458h,002000000h
dd 00000304h,000000000h
dd 00000384h,000000000h
dd 00080100h,000000000h
dd 00080108h,002000000h
dd 00000284h,000000000h
dd 00080200h,000000000h
dd 00080208h,002000000h
dd 0000026ch,00000001ch
dd 00000274h,000000000h
dd -1,-1                        ;end of list...
nic_restart_d2:
dd 00000438h,0000001d4h
dd 0000043ch,0000005f2h
dd 00000464h,000002620h
dd 00000500h,000000008h
dd 00002010h,000000181h
dd 00002018h,000390407h
dd 00002014h,000000001h
dd 00000c0ch,000ffffffh
dd 00000c08h,000000003h
dd 00003c00h,000000000h
dd 00003c08h,000000014h
dd 00003c0ch,000000048h
dd 00003c10h,000000005h
dd 00003c14h,000000035h
dd 00003c20h,000000005h
dd 00003c24h,000000005h
dd 00003c38h,000000000h
dd 00003c00h,000000702h
dd 00003000h,000000006h
dd 00002000h,000000002h
dd 00008300h,000000000h
dd 00008304h,000000000h
dd 00008308h,000000000h
dd 0000830ch,000000000h
dd 00008310h,000000000h
dd 00008314h,000000000h
dd 00008318h,000000000h
dd 0000831ch,000000000h
dd 00008320h,000000000h
dd 00008324h,000000000h
dd 00008328h,000000000h
dd 0000832ch,000000000h
dd 00008330h,000000000h
dd 00008334h,000000000h
dd 00008338h,000000000h
dd 0000833ch,000000000h
dd 00008340h,000000000h
dd 00008344h,000000000h
dd 00008348h,000000000h
dd 0000834ch,000000000h
dd 00008350h,000000000h
dd 00008354h,000000000h
dd 00008358h,000000000h
dd 0000835ch,000000000h
dd 00008360h,000000000h
dd 00008364h,000000000h
dd 00008368h,000000000h
dd 0000836ch,000000000h
dd 00008370h,000000000h
dd 00008374h,000000000h
dd 00008378h,000000000h
dd 0000837ch,000000000h
dd 00008380h,000000000h
dd 00008384h,000000000h
dd 00008388h,000000000h
dd 0000838ch,000000000h
dd 00008390h,000000000h
dd 00008394h,000000000h
dd 00008398h,000000000h
dd 0000839ch,000000000h
dd 000083a0h,000000000h
dd 000083a4h,000000000h
dd 000083a8h,000000000h
dd 000083ach,000000000h
dd 000083b0h,000000000h
dd 000083b4h,000000000h
dd 000083b8h,000000000h
dd 000083bch,000000000h
dd 000083c0h,000000000h
dd 000083c4h,000000000h
dd 000083c8h,000000000h
dd 000083cch,000000000h
dd 000083d0h,000000000h
dd 000083d4h,000000000h
dd 000083d8h,000000000h
dd 000083dch,000000000h
dd 000083e0h,000000000h
dd 000083e4h,000000000h
dd 000083e8h,000000000h
dd 000083ech,000000000h
dd 000083f0h,000000000h
dd 000083f4h,000000000h
dd 000083f8h,000000000h
dd 000083fch,000000000h
dd 00008400h,000000000h
dd 00008404h,000000000h
dd 00008408h,000000000h
dd 0000840ch,000000000h
dd 00008410h,000000000h
dd 00008414h,000000000h
dd 00008418h,000000000h
dd 0000841ch,000000000h
dd 00008420h,000000000h
dd 00008424h,000000000h
dd 00008428h,000000000h
dd 0000842ch,000000000h
dd 00008430h,000000000h
dd 00008434h,000000000h
dd 00008438h,000000000h
dd 0000843ch,000000000h
dd 00008440h,000000000h
dd 00008444h,000000000h
dd 00008448h,000000000h
dd 0000844ch,000000000h
dd 00008450h,000000000h
dd 00008454h,000000000h
dd 00008458h,000000000h
dd 0000845ch,000000000h
dd 00008460h,000000000h
dd 00008464h,000000000h
dd 00008468h,000000000h
dd 0000846ch,000000000h
dd 00008470h,000000000h
dd 00008474h,000000000h
dd 00008478h,000000000h
dd 0000847ch,000000000h
dd 00008480h,000000000h
dd 00008484h,000000000h
dd 00008488h,000000000h
dd 0000848ch,000000000h
dd 00008490h,000000000h
dd 00008494h,000000000h
dd 00008498h,000000000h
dd 0000849ch,000000000h
dd 000084a0h,000000000h
dd 000084a4h,000000000h
dd 000084a8h,000000000h
dd 000084ach,000000000h
dd 000084b0h,000000000h
dd 000084b4h,000000000h
dd 000084b8h,000000000h
dd 000084bch,000000000h
dd 000084c0h,000000000h
dd 000084c4h,000000000h
dd 000084c8h,000000000h
dd 000084cch,000000000h
dd 000084d0h,000000000h
dd 000084d4h,000000000h
dd 000084d8h,000000000h
dd 000084dch,000000000h
dd 000084e0h,000000000h
dd 000084e4h,000000000h
dd 000084e8h,000000000h
dd 000084ech,000000000h
dd 000084f0h,000000000h
dd 000084f4h,000000000h
dd 000084f8h,000000000h
dd 000084fch,000000000h
dd 00008500h,000000000h
dd 00008504h,000000000h
dd 00008508h,000000000h
dd 0000850ch,000000000h
dd 00008510h,000000000h
dd 00008514h,000000000h
dd 00008518h,000000000h
dd 0000851ch,000000000h
dd 00008520h,000000000h
dd 00008524h,000000000h
dd 00008528h,000000000h
dd 0000852ch,000000000h
dd 00008530h,000000000h
dd 00008534h,000000000h
dd 00008538h,000000000h
dd 0000853ch,000000000h
dd 00008540h,000000000h
dd 00008544h,000000000h
dd 00008548h,000000000h
dd 0000854ch,000000000h
dd 00008550h,000000000h
dd 00008554h,000000000h
dd 00008558h,000000000h
dd 0000855ch,000000000h
dd 00008560h,000000000h
dd 00008564h,000000000h
dd 00008568h,000000000h
dd 0000856ch,000000000h
dd 00008570h,000000000h
dd 00008574h,000000000h
dd 00008578h,000000000h
dd 0000857ch,000000000h
dd 00008580h,000000000h
dd 00008584h,000000000h
dd 00008588h,000000000h
dd 0000858ch,000000000h
dd 00008590h,000000000h
dd 00008594h,000000000h
dd 00008598h,000000000h
dd 0000859ch,000000000h
dd 000085a0h,000000000h
dd 000085a4h,000000000h
dd 000085a8h,000000000h
dd 000085ach,000000000h
dd 000085b0h,000000000h
dd 000085b4h,000000000h
dd 000085b8h,000000000h
dd 000085bch,000000000h
dd 000085c0h,000000000h
dd 000085c4h,000000000h
dd 000085c8h,000000000h
dd 000085cch,000000000h
dd 000085d0h,000000000h
dd 000085d4h,000000000h
dd 000085d8h,000000000h
dd 000085dch,000000000h
dd 000085e0h,000000000h
dd 000085e4h,000000000h
dd 000085e8h,000000000h
dd 000085ech,000000000h
dd 000085f0h,000000000h
dd 000085f4h,000000000h
dd 000085f8h,000000000h
dd 000085fch,000000000h
dd 00008600h,000000000h
dd 00008604h,000000000h
dd 00008608h,000000000h
dd 0000860ch,000000000h
dd 00008610h,000000000h
dd 00008614h,000000000h
dd 00008618h,000000000h
dd 0000861ch,000000000h
dd 00008620h,000000000h
dd 00008624h,000000000h
dd 00008628h,000000000h
dd 0000862ch,000000000h
dd 00008630h,000000000h
dd 00008634h,000000000h
dd 00008638h,000000000h
dd 0000863ch,000000000h
dd 00008640h,000000000h
dd 00008644h,000000000h
dd 00008648h,000000000h
dd 0000864ch,000000000h
dd 00008650h,000000000h
dd 00008654h,000000000h
dd 00008658h,000000000h
dd 0000865ch,000000000h
dd 00008660h,000000000h
dd 00008664h,000000000h
dd 00008668h,000000000h
dd 0000866ch,000000000h
dd 00008670h,000000000h
dd 00008674h,000000000h
dd 00008678h,000000000h
dd 0000867ch,000000000h
dd 00008680h,000000000h
dd 00008684h,000000000h
dd 00008688h,000000000h
dd 0000868ch,000000000h
dd 00008690h,000000000h
dd 00008694h,000000000h
dd 00008698h,000000000h
dd 0000869ch,000000000h
dd 000086a0h,000000000h
dd 000086a4h,000000000h
dd 000086a8h,000000000h
dd 000086ach,000000000h
dd 000086b0h,000000000h
dd 000086b4h,000000000h
dd 000086b8h,000000000h
dd 000086bch,000000000h
dd 000086c0h,000000000h
dd 000086c4h,000000000h
dd 000086c8h,000000000h
dd 000086cch,000000000h
dd 000086d0h,000000000h
dd 000086d4h,000000000h
dd 000086d8h,000000000h
dd 000086dch,000000000h
dd 000086e0h,000000000h
dd 000086e4h,000000000h
dd 000086e8h,000000000h
dd 000086ech,000000000h
dd 000086f0h,000000000h
dd 000086f4h,000000000h
dd 000086f8h,000000000h
dd 000086fch,000000000h
dd 00008700h,000000000h
dd 00008704h,000000000h
dd 00008708h,000000000h
dd 0000870ch,000000000h
dd 00008710h,000000000h
dd 00008714h,000000000h
dd 00008718h,000000000h
dd 0000871ch,000000000h
dd 00008720h,000000000h
dd 00008724h,000000000h
dd 00008728h,000000000h
dd 0000872ch,000000000h
dd 00008730h,000000000h
dd 00008734h,000000000h
dd 00008738h,000000000h
dd 0000873ch,000000000h
dd 00008740h,000000000h
dd 00008744h,000000000h
dd 00008748h,000000000h
dd 0000874ch,000000000h
dd 00008750h,000000000h
dd 00008754h,000000000h
dd 00008758h,000000000h
dd 0000875ch,000000000h
dd 00008760h,000000000h
dd 00008764h,000000000h
dd 00008768h,000000000h
dd 0000876ch,000000000h
dd 00008770h,000000000h
dd 00008774h,000000000h
dd 00008778h,000000000h
dd 0000877ch,000000000h
dd 00008780h,000000000h
dd 00008784h,000000000h
dd 00008788h,000000000h
dd 0000878ch,000000000h
dd 00008790h,000000000h
dd 00008794h,000000000h
dd 00008798h,000000000h
dd 0000879ch,000000000h
dd 000087a0h,000000000h
dd 000087a4h,000000000h
dd 000087a8h,000000000h
dd 000087ach,000000000h
dd 000087b0h,000000000h
dd 000087b4h,000000000h
dd 000087b8h,000000000h
dd 000087bch,000000000h
dd 000087c0h,000000000h
dd 000087c4h,000000000h
dd 000087c8h,000000000h
dd 000087cch,000000000h
dd 000087d0h,000000000h
dd 000087d4h,000000000h
dd 000087d8h,000000000h
dd 000087dch,000000000h
dd 000087e0h,000000000h
dd 000087e4h,000000000h
dd 000087e8h,000000000h
dd 000087ech,000000000h
dd 000087f0h,000000000h
dd 000087f4h,000000000h
dd 000087f8h,000000000h
dd 000087fch,000000000h
dd 00008800h,000000000h
dd 00008804h,000000000h
dd 00008808h,000000000h
dd 0000880ch,000000000h
dd 00008810h,000000000h
dd 00008814h,000000000h
dd 00008818h,000000000h
dd 0000881ch,000000000h
dd 00008820h,000000000h
dd 00008824h,000000000h
dd 00008828h,000000000h
dd 0000882ch,000000000h
dd 00008830h,000000000h
dd 00008834h,000000000h
dd 00008838h,000000000h
dd 0000883ch,000000000h
dd 00008840h,000000000h
dd 00008844h,000000000h
dd 00008848h,000000000h
dd 0000884ch,000000000h
dd 00008850h,000000000h
dd 00008854h,000000000h
dd 00008858h,000000000h
dd 0000885ch,000000000h
dd 00008860h,000000000h
dd 00008864h,000000000h
dd 00008868h,000000000h
dd 0000886ch,000000000h
dd 00008870h,000000000h
dd 00008874h,000000000h
dd 00008878h,000000000h
dd 0000887ch,000000000h
dd 00008880h,000000000h
dd 00008884h,000000000h
dd 00008888h,000000000h
dd 0000888ch,000000000h
dd 00008890h,000000000h
dd 00008894h,000000000h
dd 00008898h,000000000h
dd 0000889ch,000000000h
dd 000088a0h,000000000h
dd 000088a4h,000000000h
dd 000088a8h,000000000h
dd 000088ach,000000000h
dd 000088b0h,000000000h
dd 000088b4h,000000000h
dd 000088b8h,000000000h
dd 000088bch,000000000h
dd 000088c0h,000000000h
dd 000088c4h,000000000h
dd 000088c8h,000000000h
dd 000088cch,000000000h
dd 000088d0h,000000000h
dd 000088d4h,000000000h
dd 000088d8h,000000000h
dd 000088dch,000000000h
dd 000088e0h,000000000h
dd 000088e4h,000000000h
dd 000088e8h,000000000h
dd 000088ech,000000000h
dd 000088f0h,000000000h
dd 000088f4h,000000000h
dd 000088f8h,000000000h
dd 000088fch,000000000h
dd 00008900h,000000000h
dd 00008904h,000000000h
dd 00008908h,000000000h
dd 0000890ch,000000000h
dd 00008910h,000000000h
dd 00008914h,000000000h
dd 00008918h,000000000h
dd 0000891ch,000000000h
dd 00008920h,000000000h
dd 00008924h,000000000h
dd 00008928h,000000000h
dd 0000892ch,000000000h
dd 00008930h,000000000h
dd 00008934h,000000000h
dd 00008938h,000000000h
dd 0000893ch,000000000h
dd 00008940h,000000000h
dd 00008944h,000000000h
dd 00008948h,000000000h
dd 0000894ch,000000000h
dd 00008950h,000000000h
dd 00008954h,000000000h
dd 00008958h,000000000h
dd 0000895ch,000000000h
dd 00008960h,000000000h
dd 00008964h,000000000h
dd 00008968h,000000000h
dd 0000896ch,000000000h
dd 00008970h,000000000h
dd 00008974h,000000000h
dd 00008978h,000000000h
dd 0000897ch,000000000h
dd 00008980h,000000000h
dd 00008984h,000000000h
dd 00008988h,000000000h
dd 0000898ch,000000000h
dd 00008990h,000000000h
dd 00008994h,000000000h
dd 00008998h,000000000h
dd 0000899ch,000000000h
dd 000089a0h,000000000h
dd 000089a4h,000000000h
dd 000089a8h,000000000h
dd 000089ach,000000000h
dd 000089b0h,000000000h
dd 000089b4h,000000000h
dd 000089b8h,000000000h
dd 000089bch,000000000h
dd 000089c0h,000000000h
dd 000089c4h,000000000h
dd 000089c8h,000000000h
dd 000089cch,000000000h
dd 000089d0h,000000000h
dd 000089d4h,000000000h
dd 000089d8h,000000000h
dd 000089dch,000000000h
dd 000089e0h,000000000h
dd 000089e4h,000000000h
dd 000089e8h,000000000h
dd 000089ech,000000000h
dd 000089f0h,000000000h
dd 000089f4h,000000000h
dd 000089f8h,000000000h
dd 000089fch,000000000h
dd 00008a00h,000000000h
dd 00008a04h,000000000h
dd 00008a08h,000000000h
dd 00008a0ch,000000000h
dd 00008a10h,000000000h
dd 00008a14h,000000000h
dd 00008a18h,000000000h
dd 00008a1ch,000000000h
dd 00008a20h,000000000h
dd 00008a24h,000000000h
dd 00008a28h,000000000h
dd 00008a2ch,000000000h
dd 00008a30h,000000000h
dd 00008a34h,000000000h
dd 00008a38h,000000000h
dd 00008a3ch,000000000h
dd 00008a40h,000000000h
dd 00008a44h,000000000h
dd 00008a48h,000000000h
dd 00008a4ch,000000000h
dd 00008a50h,000000000h
dd 00008a54h,000000000h
dd 00008a58h,000000000h
dd 00008a5ch,000000000h
dd 00008a60h,000000000h
dd 00008a64h,000000000h
dd 00008a68h,000000000h
dd 00008a6ch,000000000h
dd 00008a70h,000000000h
dd 00008a74h,000000000h
dd 00008a78h,000000000h
dd 00008a7ch,000000000h
dd 00008a80h,000000000h
dd 00008a84h,000000000h
dd 00008a88h,000000000h
dd 00008a8ch,000000000h
dd 00008a90h,000000000h
dd 00008a94h,000000000h
dd 00008a98h,000000000h
dd 00008a9ch,000000000h
dd 00008aa0h,000000000h
dd 00008aa4h,000000000h
dd 00008aa8h,000000000h
dd 00008aach,000000000h
dd 00008ab0h,000000000h
dd 00008ab4h,000000000h
dd 00008ab8h,000000000h
dd 00008abch,000000000h
dd 00008ac0h,000000000h
dd 00008ac4h,000000000h
dd 00008ac8h,000000000h
dd 00008acch,000000000h
dd 00008ad0h,000000000h
dd 00008ad4h,000000000h
dd 00008ad8h,000000000h
dd 00008adch,000000000h
dd 00008ae0h,000000000h
dd 00008ae4h,000000000h
dd 00008ae8h,000000000h
dd 00008aech,000000000h
dd 00008af0h,000000000h
dd 00008af4h,000000000h
dd 00008af8h,000000000h
dd 00008afch,000000000h
dd 00008b00h,000000000h
dd 00008b04h,000000000h
dd 00008b08h,000000000h
dd 00008b0ch,000000000h
dd 00008b10h,000000000h
dd 00008b14h,000000000h
dd 00008b18h,000000000h
dd 00008b1ch,000000000h
dd 00008b20h,000000000h
dd 00008b24h,000000000h
dd 00008b28h,000000000h
dd 00008b2ch,000000000h
dd 00008b30h,000000000h
dd 00008b34h,000000000h
dd 00008b38h,000000000h
dd 00008b3ch,000000000h
dd 00008b40h,000000000h
dd 00008b44h,000000000h
dd 00008b48h,000000000h
dd 00008b4ch,000000000h
dd 00000400h,000e0d800h
dd 00006808h,001009008h
dd 00000204h,000000000h
dd 00004c00h,0000003feh
dd 00000040h,000000000h
dd 00004800h,0080303feh
dd 00002800h,000000006h
dd 00001000h,000000002h
dd 00001c00h,000000006h
dd 00002c00h,000000006h
dd 00002400h,000000012h
dd 00000c00h,000000002h
dd 00000c00h,00000000ah
dd 00001800h,000000006h
dd 00001400h,000000006h
dd 0000045ch,000000002h
dd 00000468h,000000002h
dd 00000454h,0000c0000h
dd 0000040ch,000000800h
dd 00000450h,000000001h
dd 00000468h,000000002h
dd 00000504h,000000002h
dd 0000044ch,028210000h
dd 0000044ch,028210000h
dd 0000044ch,028210000h
dd 0000044ch,028210000h
dd 0000044ch,028210000h
dd 0000044ch,028210000h
dd 0000044ch,028210000h
dd 0000044ch,028210000h
dd 0000044ch,028210000h
dd 0000044ch,028210000h
dd 0000044ch,028210000h
dd 0000044ch,028210000h
dd 0000044ch,028210000h
dd 0000044ch,028210000h
dd 0000044ch,028210000h
dd 0000044ch,028210000h
dd 0000044ch,028210000h
dd 0000044ch,028210000h
dd 0000044ch,028210000h
dd 0000044ch,028210000h
dd 0000044ch,028210000h
dd 0000044ch,028210000h
dd 0000044ch,028210000h
dd 0000044ch,028210000h
dd 0000044ch,028210000h
dd 0000044ch,028210000h
dd 0000044ch,028210000h
dd 0000044ch,028210000h
dd 0000044ch,028210000h
dd 0000044ch,028210000h
dd 0000044ch,028210000h
dd 0000044ch,028210000h
dd 0000044ch,028210000h
dd 0000044ch,028210000h
dd 0000044ch,028210000h
dd 0000044ch,028210000h
dd 0000044ch,028210000h
dd 0000044ch,028210000h
dd 0000044ch,028210000h
dd 0000044ch,028210000h
dd 0000044ch,028210000h
dd 0000044ch,028210000h
dd 0000044ch,028210000h
dd 0000044ch,028210000h
dd 0000044ch,028210000h
dd 0000044ch,028210000h
dd 0000044ch,028210000h
dd 0000044ch,028210000h
dd 0000044ch,028210000h
dd 0000044ch,028210000h
dd 0000044ch,028210000h
dd 0000044ch,028210000h
dd 0000044ch,028210000h
dd 0000044ch,028210000h
dd 0000044ch,028210000h
dd 0000044ch,028210000h
dd 0000044ch,028210000h
dd 0000044ch,028210000h
dd 0000044ch,028210000h
dd 0000044ch,028210000h
dd 0000044ch,028210000h
dd 0000044ch,028210000h
dd 0000044ch,028210000h
dd 0000044ch,028210000h
dd 0000044ch,028210000h
dd 0000044ch,028210000h
dd 0000044ch,028210000h
dd 0000044ch,028210000h
dd 0000044ch,028210000h
dd 0000044ch,028210000h
dd 0000044ch,028210000h
dd 0000044ch,028210000h
dd 0000044ch,028210000h
dd 0000044ch,028210000h
dd 0000044ch,028210000h
dd 0000044ch,028210000h
dd 0000044ch,028210000h
dd 0000044ch,028210000h
dd 0000044ch,028210000h
dd 0000044ch,028210000h
dd 0000044ch,028210000h
dd 0000044ch,028210000h
dd 0000044ch,028210000h
dd 0000044ch,028210000h
dd 0000044ch,028210000h
dd 0000044ch,028210000h
dd 0000044ch,0242405e1h
dd 0000044ch,024290300h
dd 0000044ch,024201200h
dd 0000044ch,028210000h
dd 0000044ch,028210000h
dd 00000400h,000e04808h
dd 00000408h,000001000h
dd 00000464h,000002620h
dd 0000044ch,0283e0000h
dd 0000044ch,0243e8000h
dd 0000044ch,028340000h
dd 00000470h,000000000h
dd 00000474h,000000000h
dd 00000478h,000000000h
dd 0000047ch,000000000h
dd 00000468h,000000402h
dd 00000480h,042000000h
dd 00000484h,07fffffffh
dd 00000488h,006000004h
dd 0000048ch,07fffffffh
dd 000004b8h,000000000h
dd 000004bch,000000000h
dd 000004b0h,000000000h
dd 000004b4h,000000000h
dd 000004a8h,000000000h
dd 000004ach,000000000h
dd 000004a0h,000000000h
dd 000004a4h,000000000h
dd 00000068h,041010298h
dd 00000204h,000000000h
dd 00000470h,000000000h
dd 00000474h,000000000h
dd 00000478h,000000000h
dd 0000047ch,000000000h
dd 00000470h,000000000h
dd 00000474h,000000000h
dd 00000478h,000000000h
dd 0000047ch,000000000h
dd 0000044ch,028200000h
dd 0000044ch,028210000h
dd 0000044ch,028200000h
dd 0000044ch,028210000h
dd 0000044ch,028220000h
dd 0000044ch,028230000h
dd 0000044ch,028240000h
dd 0000044ch,028250000h
dd 0000044ch,028260000h
dd 0000044ch,028270000h
dd 0000044ch,028200000h
dd 0000044ch,028210000h
dd 0000044ch,028200000h
dd 0000044ch,028210000h
dd 0000044ch,028220000h
dd 0000044ch,028230000h
dd 0000044ch,028240000h
dd 0000044ch,028250000h
dd 0000044ch,028260000h
dd 0000044ch,028270000h
dd 0000044ch,028200000h
dd 0000044ch,028210000h
dd 0000044ch,028200000h
dd 0000044ch,028210000h
dd 0000044ch,028220000h
dd 0000044ch,028230000h
dd 0000044ch,028240000h
dd 0000044ch,028250000h
dd 0000044ch,028260000h
dd 0000044ch,028270000h
dd 0000044ch,028200000h
dd 0000044ch,028210000h
dd 0000044ch,028200000h
dd 0000044ch,028210000h
dd 0000044ch,028220000h
dd 0000044ch,028230000h
dd 0000044ch,028240000h
dd 0000044ch,028250000h
dd 0000044ch,028260000h
dd 0000044ch,028270000h
dd 0000044ch,028200000h
dd 0000044ch,028210000h
dd 0000044ch,028200000h
dd 0000044ch,028210000h
dd 0000044ch,028220000h
dd 0000044ch,028230000h
dd 0000044ch,028240000h
dd 0000044ch,028250000h
dd 0000044ch,028260000h
dd 0000044ch,028270000h
dd 00000204h,000000001h
dd 00000408h,000000000h
dd 00000404h,000401018h
dd 00000454h,0000c0000h
dd 0000044ch,024380002h
dd 0000044ch,0283a0000h
dd 0000044ch,0283a0000h
dd 0000044ch,0243bffffh
dd 0000044ch,028210000h
dd 0000044ch,028210000h
dd 0000044ch,028390000h
dd 0000044ch,028390000h
dd 0000044ch,028200000h
dd 0000044ch,028200000h
dd 0000044ch,028240000h
dd 0000044ch,028290000h
dd 00000400h,000e04c06h
dd 00000408h,000001000h
dd -1,-1                        ;end of list...
nic_restart_d3:
dd 470h,-1,474h,-1              ;multicast filter...
dd 478h,-1,47ch,-1
dd -1,-1                        ;end of list...
nic_restart_j1:
lodsd cs,ptr32
inc eax
jz byte nic_restart_j2
lea edx,def:[eax-1]
lodsd cs,ptr32
call dword bcm_write
call dword timer_relequish
jmp byte nic_restart_j1
nic_restart_j2:
retnd
nic_restart_j3:
add eax,def:[bcm_phyMem]
add dx,4
call dword bcm_write
sub dx,4
sub eax,eax
call dword bcm_write
retnd
endp
;-------------------------------

;-------------------------------
proc nic_test4dead
clc
retnd
endp
;-------------------------------

;-------------------------------
proc nic_ready4tx
mov esi,def:[bcm_mapMem]
add esi,bcm_buf6
movzx word eax,def:[esi+18]
cmp eax,def:[bcm_txNext]
jne byte nic_ready4tx_err
clc
retnd
nic_ready4tx_err:
stc
retnd
endp
;-------------------------------

;-------------------------------
proc nic_send
movzx byte eax,def:[bcm_TxNxQu]
inc eax
sub edx,edx
mov esi,bcm_TxQueue
div esi
movzx eax,dl
mov def:[bcm_TxNxQu],al
imul edi,eax,600h
add edi,bcm_buf2
mov ebp,edi
add edi,def:[bcm_mapMem]
;build packet header...
mov esi,dataSeg_freMem
movsd ptr32
movsw ptr32
mov ebx,esi
mov esi,dataSeg_parAdr
movsd ptr32
movsw ptr32
mov esi,ebx
mov ebx,ecx
add ecx,3
shr ecx,2
rep
  movsd ptr32
mov eax,def:[bcm_TxNext]
inc eax
sub edx,edx
mov esi,bcm_TxMax
div esi
xchg edx,def:[bcm_TxNext]
shl edx,4
mov edi,bcm_buf4
add edi,edx
add edi,def:[bcm_mapMem]
sub eax,eax
stosd ptr32
mov eax,ebp
add eax,def:[bcm_phyMem]
stosd ptr32
lea eax,def:[ebx+12]
shl eax,16
or eax,4
stosd ptr32
sub eax,eax
stosd ptr32
mov eax,def:[bcm_TxNext]
mov dx,304h
call dword bcm_write
mov eax,1
mov dx,204h
call dword bcm_write
mov eax,08000000h
mov dx,204h
call dword bcm_write
retnd
endp
;-------------------------------

;-------------------------------
proc nic_receive
mov esi,def:[bcm_mapMem]
add esi,bcm_buf6
movzx word eax,def:[esi+16]
cmp eax,def:[bcm_rxNext]
je dword nic_receive_err
mov eax,def:[bcm_rxNext]
shl eax,5
mov edi,bcm_buf5
add edi,eax
add edi,def:[bcm_mapMem]
movzx word ebp,def:[edi+8]
sub edi,bcm_buf5
add edi,bcm_buf3
mov esi,def:[edi+4]
sub esi,def:[bcm_phyMem]
add esi,def:[bcm_mapMem]
sub bp,16
and bp,7ffh
mov edi,dataSeg_freMem
add esi,6                       ;skip target address...
movsd ptr32
movsw ptr32
lea ecx,def:[ebp+3]
shr ecx,2
rep
  movsd ptr32
mov eax,def:[bcm_rxNext]
inc eax
sub edx,edx
mov esi,bcm_rxMax
div esi
mov def:[bcm_rxNext],edx
mov eax,edx
mov dx,284h
call dword bcm_write
mov eax,bcm_RxQueue
add eax,def:[bcm_rxNext]
sub edx,edx
mov esi,bcm_rxMax
div esi
mov eax,edx
mov dx,26ch
call dword bcm_write
mov eax,08000000h
mov dx,204h
call dword bcm_write
mov ecx,ebp
retnd
nic_receive_err:
sub ecx,ecx
retnd
endp
;-------------------------------
