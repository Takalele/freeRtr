use32                           ;these are just data, so let it nice;)
;-------------------------------

;------------------------------- kernel info...
kernel_id1:
db 'name: BugOS Kernel',13,10
db 'version: 2.0',13,10
db 'date: ',%date,13,10
db 'time: ',%time,13,10
db 'coder: Mc',13,10
db 0
;------------------------------- kernel logo...
kernel_id2:
db 'ﬂ€€ﬂﬂ€‹   Coded by Mc   ‹€ﬂﬂﬂ€‹ ‹€ﬂﬂﬂ€‹',13,10
db ' €€  €€ ‹‹  ‹‹   ‹‹‹ ‹‹ €€   €€ ﬂ€‹  ﬂﬂ',13,10
db ' €€ﬂﬂ€‹ €€  €€  €€  €€  €€   €€   ﬂﬂ€‹',13,10
db ' €€  €€ €€  €€  €€  €€  €€   €€ ‹‹   €€',13,10
db '‹€€‹‹€ﬂ ﬂ€‹‹ﬂ€‹ ﬂ€‹‹€€  ﬂ€‹‹‹€ﬂ ﬂ€‹‹‹€ﬂ',13,10
db '                ‹‹  €€',13,10
db '                 ﬂﬂﬂﬂ      Kernel v2.0',13,10
db 0
;-------------------------------

;------------------------------- general texts...
textCRLF db 13,10,0
text001 db 'error: ',0
text002 db 'i80386+ cpu not found!',0
text003 db 'cpu already in protected mode!',0
text004 db 'failed to enable a20 line!',0
text005 db 'at least 2mb of memory required!',0
text006 db 'back to real mode, going to reboot...',0
text007 db '@',driveSeparatorChar,pathSeparatorChar,'startupRamDrive.Code',0
text008 db '@',driveSeparatorChar,pathSeparatorChar,'ramDriveStarter.Code',0
text009 db 'exception #',0
text010 db ': ',0
text011 db '  ',0
text012 db 'pid=',0
text013 db 'par=',0
text014 db 'uid=',0
text015 db 'rgt=',0
text016 db 'eax=',0
text017 db 'ebx=',0
text018 db 'ecx=',0
text019 db 'edx=',0
text020 db 'esi=',0
text021 db 'edi=',0
text022 db 'ebp=',0
text023 db 'eip=',0
text024 db 'esp=',0
text025 db 'flg=',0
text026 db 'cs=',0
text027 db 'ss=',0
text028 db 'ds=',0
text029 db 'es=',0
text030 db 'fs=',0
text031 db 'gs=',0
text032 db 'pathname=',0
text033 db 'parameter=',0
text034 db '0123456789ABCDEF',0
text035 db '@',driveSeparatorChar,pathSeparatorChar,0
;-------------------------------

;------------------------------- exception names...
textExUd db 'undefinied',0
textEx00 db 'divide by zero',0
textEx01 db 'single step',0
textEx02 db 'non maskable interrupt',0
textEx03 db 'int3 breakpoint',0
textEx04 db 'overflow trap',0
textEx05 db 'bound range exceeded',0
textEx06 db 'invalid opcode',0
textEx07 db 'coprocessor not available',0
textEx08 db 'double fault exception',0
textEx09 db 'coprocessor segment overrun',0
textEx10 db 'invalid task state segment',0
textEx11 db 'segment not present',0
textEx12 db 'stack exception',0
textEx13 db 'general protection fault',0
textEx14 db 'page fault',0
textEx16 db 'coprocessor error',0
textEx17 db 'alignment check fault',0
textEx18 db 'machine check fault',0
;-------------------------------

;------------------------------- init process binary...
initProcess_beg:
incbin initproc.code
initProcess_end:
;-------------------------------

;------------------------------- descriptor tables...
align 10h
GlobalDescrTab:                 ;global descriptor table...
db 0,0,0,0,0,0,0,0
db 0,0,0,0,0,11111011b,11010000b,0    ;sel_ProcCode
db 0,0,0,0,0,11110011b,11010000b,0    ;sel_ProcData
db 0,0,0,0,0,11110011b,11010000b,0    ;sel_ProcStak
db 0,0,0,0,0,10010011b,11010000b,0    ;sel_raw4gbMem
db 0,0,0,0,0,10011011b,00010000b,0    ;sel_code16
db 0,0,0,0,0,10010011b,00010000b,0    ;sel_data16
db 0,0,0,0,0,10011011b,01010000b,0    ;sel_KernelLO
db 0,0,0,0,0,10011011b,01010000b,0    ;sel_KernelHI
db 0,0,0,0,0,10010011b,01010000b,0    ;sel_KernelRW
db 0,0,0,0,0,10010011b,01010000b,0    ;sel_KernelStk
db 0,0,0,0,0,10010011b,01010000b,0    ;sel_KernelBuf
db 0,0,0,0,0,10001001b,01010000b,0    ;sel_defTSS
GlobDescrLoad:
GlobDescrSize dw 0
GlobDescrBase dd 0
IntrDescrTable dd 256 dup (0,0) ;interrupt descriptor table...
IntrDescrLoad:
IntrDescrSize dw 0
IntrDescrBase dd 0
;------------------------------- selectors...
sel_ProcCode equ 0bh            ;process 32 bit code executable...
sel_ProcData equ 13h            ;process 32 bit data read/write...
sel_ProcStak equ 1bh            ;process 32 bit stack read/write...
sel_raw4gbMem equ 20h           ;raw read/write 4gb memory...
sel_code16 equ 28h              ;kernel 16 bit physical executable...
sel_data16 equ 30h              ;kernel 16 bit physical read/write...
sel_KernelLO equ 38h            ;kernel 32 bit physical executable...
sel_KernelHI equ 40h            ;kernel 32 bit logical executable...
sel_KernelRW equ 48h            ;kernel 32 bit logical read/write...
sel_KernelStk equ 50h           ;kernel 32 bit stack read/write...
sel_KernelBuf equ 58h           ;kernel 32 bit buffer read/write...
sel_defaultTSS equ 60h          ;default 32 bit tss to use...
;------------------------------- general data...
irqHookingTable dd 48 dup (0)   ;irq hook table...
driveHookTable dd 512 dup (0)   ;drive hook table...
cpuManufacturer db 32 dup (0)   ;cpu model name...
cpuFamilyCode dd 0              ;cpu family: 3=386, 4=486, 5=586...
TicksPerOneDay dd 0             ;ticks occuring in one day...
StartupPastTick dd 0            ;ticks past since startup...
StartupPastDays dd 0            ;days past since startup...
MemorySizePages dd 0            ;total physical memory in pages...
MemoryUsageMap dd 0             ;memory usage map offset...
LinearPagingTab dd 0            ;linear paging table offset...
DefaultFlagsReg dd 0            ;default flags to give...
OpenFileListing dd fileLst__siz ;size of entry...
OpenFileNumber dd 0             ;number open files...
OpenFilePagTab dd 0             ;open files paging table offset...
ProcListListing dd 4096         ;size of entry...
ProcListNumber dd 0             ;number of processes...
ProcListPagTab dd 0             ;process list paging table offset...
PipeLineListing dd pipeLst__siz ;size of entry...
PipeLineNumber dd 0             ;number of pipelines...
PipeLinePagTab dd 0             ;pipeline list paging table offset...
NextNewProcNum dd 0             ;next process number to give...
NextNewFileNum dd 0             ;next file handler to give...
NextNewPipeNum dd 0             ;next pipeline number to give...
SystemIdleEnab dd 0             ;sti;hlt; instructions enabled...
SystemIdleTime dd 0             ;times the system executed halt...
SystemRoundDon dd 0             ;rounds done by system...
SystemFulRndDn dd 0             ;full rounds done...
SystemActvStrt dd 0             ;active process starts...
RoundUntilSlep dd 0             ;rounds since deep sleep...
RoundUntilFull dd 0             ;rounds since full round...
CurrentProcNum dd 0             ;current process number...
CurrentProcPid dd 0             ;current process pid...
CurrentProcPag dd 0             ;current process page table...
ActiveDrivePid dd 0             ;active drive process id...
ActiveDriveUsr dd 0             ;active drive user process id...
ActiveDriveTim dd 0             ;active drive tim started...
ActiveDrivePag dd 0             ;active drive user page table...
ActiveDriveBuf dd 0             ;active drive comm buffer...
ActiveDriveSrc dd 0             ;active drive source offset...
ActiveDriveTrg dd 0             ;active drive target offset...
ActiveDriveSiz dd 0             ;active drive bytes to copy...
ActiveDriveHnd dd 0             ;active drive handler number...
ActiveDriveFlg dd 0             ;active drive handler flags...
ActiveDriveRgt dd 0             ;active drive handler rights...
;------------------------------- temporary storage...
process_temp_d1 dd 0            ;temporary dword...
process_temp_d2 dd 0            ;temporary dword...
process_temp_d3 dd 0            ;temporary dword...
process_temp_d4 dd 0            ;temporary dword...
process_temp_d5 dd 0            ;temporary dword...
process_temp_d6 dd 0            ;temporary dword...
pipeline_temp_d1 dd 0           ;temporary dword...
pipeline_temp_d2 dd 0           ;temporary dword...
pipeline_temp_d3 dd 0           ;temporary dword...
pipeline_temp_d4 dd 0           ;temporary dword...
pipeline_temp_d5 dd 0           ;temporary dword...
pipeline_temp_d6 dd 0           ;temporary dword...
pipeline_temp_d7 dd 0           ;temporary dword...
fileio_temp_d1 dd 0             ;temporary dword...
fileio_temp_d2 dd 0             ;temporary dword...
fileio_temp_d3 dd 0             ;temporary dword...
syscall_temp_d1 dd 0            ;temporary dword...
syscall_temp_d2 dd 0            ;temporary dword...
syscall_temp_d3 dd 0            ;temporary dword...
syscall_temp_d4 dd 0            ;temporary dword...
;------------------------------- general constants...
IRQbeginNumber equ 40h          ;where irqs are remapped...
TimerClicksPerSec equ 64        ;timer clicks per second...
MemoryTestBlock equ 1000000h    ;memory test block size...
MemoryTestOver equ 2000h        ;memory test after this size...
MemoryTestMax equ 010000000h    ;memory test maximum size...
KernelProcNum equ 0ffffffffh    ;kernel's process number...
AdminUserNum equ 0              ;administrator's uid...
SysCallCodeSize equ 6           ;size of one syscall...
pathSeparatorChar equ 92        ;the path separator char: '\'...
driveSeparatorChar equ 58       ;the drive separator char: ':'...
;------------------------------- memory constants...
KernelPhyOfs equ 1000h          ;kernel's physical offset...
KernelLogOfs equ 0ffc00000h     ;kernel's logical offset...
KernelBufOfs equ 0ffe00000h     ;kernel's buffer offset...
KernelBufSiz equ 20000h         ;kernel's buffer size...
KernelStkSiz equ 1000h          ;kernel's stack size...
KernelStkPhy equ 106000h        ;kernel's stack physical offset...
KernelStkLog equ 0ffbf8000h     ;kernel's stack logical offset...
DefaultTSSlog equ 0ffbf0000h    ;default tss logical offset...
DefaultTSSphy equ 100000h       ;default tss physical offset...
DefaultTSSsiz equ 3000h         ;default tss size...
ProcessCodeOfs equ 080000000h   ;process's code offset...
ProcessCodeSiz equ 03fffffffh   ;process's code size...
ProcessDataOfs equ 000000000h   ;process's data offset...
ProcessDataSiz equ 07fffffffh   ;process's data size...
ProcessStakOfs equ 0c0000000h   ;process's stack offset...
ProcessStakSiz equ 01fff0000h   ;process's stack size...
;------------------------------- rights...
rights_ownRead equ 01h          ;owner can read...
rights_ownWrite equ 02h         ;owner can write...
rights_ownExec equ 04h          ;owner can execute...
rights_anyRead equ 08h          ;everybody can read...
rights_anyWrite equ 10h         ;everybody can write...
rights_anyExec equ 20h          ;everybody can execute...
rights_rootPriv equ 40h         ;has root privileges (can do tricks;)
rights_directory equ 80h        ;this is a directory...
rights_allowRead equ 100h       ;allow simultaneous read...
rights_allowWrite equ 200h      ;allow simultaneous write...
rights_allowExec equ 400h       ;allow simultaneous execution...
;------------------------------- system drive commands...
sysDrvCmd_chgDir equ 001h       ;change directory...
sysDrvCmd_statst equ 102h       ;drive statistics...
sysDrvCmd_makDir equ 003h       ;create directory...
sysDrvCmd_delDir equ 004h       ;erase directory
sysDrvCmd_makFil equ 005h       ;create file...
sysDrvCmd_delFil equ 006h       ;erase file...
sysDrvCmd_rename equ 007h       ;rename...
sysDrvCmd_mkLink equ 008h       ;make link...
sysDrvCmd_stRigt equ 009h       ;set rights...
sysDrvCmd_stDate equ 00Ah       ;set date...
sysDrvCmd_drOpen equ 00Bh       ;open directory...
sysDrvCmd_drRead equ 00Ch       ;read directory...
sysDrvCmd_flOpen equ 00Dh       ;open file...
sysDrvCmd_flRead equ 00Eh       ;read file
sysDrvCmd_flWrte equ 00Fh       ;write file...
sysDrvCmd_flSeek equ 010h       ;seek file...
sysDrvCmd_flSize equ 011h       ;get file size...
sysDrvCmd_flPosi equ 012h       ;get file pos...
sysDrvCmd_flTrnc equ 013h       ;truncate file...
;------------------------------- error codes....
error_none equ 0                ;no error...
error_default equ 1             ;unknown error...
error_memSpace equ 2            ;out of memory...
error_diskSpace equ 3           ;out of disk space...
error_noRight equ 4             ;no right...
error_sharing equ 5             ;sharing violation...
error_noPath equ 6              ;path not exists...
error_notExists equ 7           ;file not exists...
error_already equ 8             ;file already exists...
error_handler equ 9             ;invalid handle...
error_dirNotEmpty equ 10        ;directory not empty...
error_dirEmbedded equ 11        ;embedded directories...
error_dirMismatch equ 12        ;file/directory mismatch...
error_pointerBig equ 13         ;file pointer too big...
error_ioFault equ 14            ;drive io fault...
error_drvNotRedy equ 15         ;drive not ready...
error_endOfFile equ 16          ;eof encountered...
error_badName equ 17            ;invalid filename format...
error_badTermin equ 18          ;abnormal program termination...
;------------------------------- process status...
status_running equ 0            ;up and running...
status_initial equ 1            ;under initialization...
status_fileio equ 2             ;fileio pending...
status_wait4exec equ 3          ;execute pending...
;------------------------------- round updater value...
rounds_fullCount equ 3fh        ;full round frequency...
rounds_idletime equ 70          ;rounds to run after idle...
rounds_activity equ 255         ;rounds to run on activity...
rounds_timeout equ 1            ;process timeslice expired...
rounds_switchTo equ 5           ;other process switched to...
rounds_pipeRx equ 3             ;pipeline receive happend...
rounds_pipeTx equ 5             ;pipeline transmit happend...
rounds_fileIo equ 5             ;file io happend...
;------------------------------- executable header layout...
execHdr_idntfy equ 00h          ;dd: executable identifier...
execHdr_codSiz equ 04h          ;dd: code size in bytes...
execHdr_datSiz equ 08h          ;dd: data size in bytes...
execHdr_stkSiz equ 0ch          ;dd: stack size in bytes...
execHdr__siz equ 10h            ;size of structure...
execHdr__idv equ 63657865h      ;executable identifier value...
;------------------------------- irq hook entry layout...
irqHook_pid equ 00h             ;dd: process id...
irqHook_eip equ 04h             ;dd: entering eip value...
irqHook_esp equ 08h             ;dd: entering esp value...
irqHook__siz equ 0ch            ;size of structure...
;------------------------------- drive list layout...
driveLst_pid equ 00h            ;dd: process id...
driveLst_buf equ 04h            ;dd: shared buffer offset...
driveLst__siz equ 08h           ;size of structure...
;------------------------------- drive buffer layout...
drvBuf_cmd equ 000h             ;dd: command/result code...
drvBuf_usr equ 004h             ;dd: user who wants to do...
drvBuf_rgt equ 008h             ;dd: rights what user wants to do...
drvBuf_siz equ 00ch             ;dd: buffer size...
drvBuf_dir equ 010h             ;256: current directory...
drvBuf_fn1 equ 110h             ;256: pathname #1...
drvBuf_fn2 equ 210h             ;256: pathname #2...
drvBuf_hdr equ 310h             ;512: file handle...
drvBuf_dat equ 510h             ;64k: data buffer...
drvBuf__siz equ 10510h          ;size of structure...
;------------------------------- open file list layout...
fileLst_dat equ 000h            ;512: file data...
fileLst_hdr equ 200h            ;dd: file handler...
fileLst_pid equ 204h            ;dd: process id...
fileLst_rgt equ 208h            ;dd: access rights...
fileLst_drv equ 20ch            ;dd: pid of drive process...
fileLst_ind equ 210h            ;dd: inode of file...
fileLst_buf equ 214h            ;dd: buffer in drive...
fileLst__siz equ 218h           ;size of structure...
;------------------------------- pipeline list layout...
pipeLst_pidC equ 00h            ;dd: caller's pid...
pipeLst_pidA equ 04h            ;dd: answerer's pid...
pipeLst_plid equ 08h            ;dd: pipeline id...
pipeLst_size equ 0ch            ;dw: size of pipeline in pages...
pipeLst_blck equ 0eh            ;db: block mode pipeline...
pipeLst_begS equ 10h            ;dd: offset of send (c->a) buffer...
pipeLst_begR equ 14h            ;dd: offset of receive (a->c) buffer...
pipeLst_sizS equ 18h            ;dd: size of send (c->a) buffer...
pipeLst_sizR equ 1ch            ;dd: size of receive (a->c) buffer...
pipeLst_posS equ 20h            ;dd: position in send (c->a) buffer...
pipeLst_posR equ 24h            ;dd: position in receive (a->c) buffer...
pipeLst_updC equ 28h            ;dd: caller's update offset...
pipeLst_updA equ 2ch            ;dd: answerer's update offset...
pipeLst_indx equ 30h            ;dd: index value for quickfind...
pipeLst__hed equ 34h            ;size of header...
pipeLst__siz equ 8000h          ;size of structure in bytes...
pipeLst__shl equ 15             ;size of structure in log2...
;------------------------------- process stack data layout...
procStk_pid equ 000h            ;dd: process id...
procStk_ppid equ 004h           ;dd: parent process id...
procStk_cuid equ 008h           ;dd: current user id...
procStk_ouid equ 00ch           ;dd: original user id...
procStk_right equ 010h          ;dd: rights...
procStk_pagtab equ 014h         ;dd: page table physical offset...
procStk_stack equ 018h          ;dd: stack physical offset...
procStk_codeSize equ 01ch       ;dd: code size in bytes...
procStk_dataSize equ 020h       ;dd: data size in bytes...
procStk_data2beg equ 024h       ;dd: extended data offset...
procStk_data2siz equ 028h       ;dd: extended data size in pages...
procStk_stakSize equ 02ch       ;dd: stack size in bytes...
procStk_pathName equ 030h       ;256: process pathname...
procStk_paramStr equ 130h       ;256: parameter string...
procStk_currDir equ 230h        ;256: current directory...
procStk_lastReleq equ 330h      ;dd: ticks since last control giveaway...
procStk_status equ 334h         ;db: status of process...
procStk_oldStat equ 335h        ;db: old status of process...
procStk_irqServ equ 336h        ;db: irq servicing in progress...
procStk_v86mode equ 337h        ;db: running in v86 mode...
procStk_rentCon equ 338h        ;dd: console owner process id...
procStk_console equ 33ch        ;dd: pipeline of console...
procStk_listen equ 340h         ;dd: pipeline of listening...
procStk_dmaPhys equ 344h        ;dd: dma-able memory physical beginning...
procStk_dmaSize equ 348h        ;dd: dma-able memory size in bytes...
procStk_execWait equ 34ch       ;dd: waiting for this pid...
procStk_missdIrq equ 350h       ;dd: number of missed irqs...
procStk_noTskSwc equ 354h       ;db: no task switch while not zero...
procStk_roundLft equ 355h       ;db: rounds left from running...
procStk_roundUpd equ 356h       ;db: rounds left updater value...
procStk_roundRun equ 358h       ;dd: rounds run because needed...
procStk_data2map equ 35ch       ;dd: mapped data offset...
procStk__siz equ 360h           ;size of structure...
procStk__dummy equ 0800h        ;dummy dword...
;------------------------------- process stack registers layout...
procStk_reg_ss  equ 0ffch       ;dd: ss register...
procStk_reg_esp equ 0ff8h       ;dd: esp register...
procStk_reg_flg equ 0ff4h       ;dd: eflags register...
procStk_reg_cs  equ 0ff0h       ;dd: cs register...
procStk_reg_eip equ 0fech       ;dd: eip register...
procStk_reg_eax equ 0fe8h       ;dd: eax register...
procStk_reg_ecx equ 0fe4h       ;dd: ecx register...
procStk_reg_edx equ 0fe0h       ;dd: edx register...
procStk_reg_ebx equ 0fdch       ;dd: ebx register...
procStk_reg_tmp equ 0fd8h       ;dd: reserved (esp register)...
procStk_reg_ebp equ 0fd4h       ;dd: ebp register...
procStk_reg_esi equ 0fd0h       ;dd: esi register...
procStk_reg_edi equ 0fcch       ;dd: edi register...
procStk_reg_iret equ 0fech      ;esp value before popad...
procStk_reg_popa equ 0fcch      ;esp value before iretd...
;-------------------------------
