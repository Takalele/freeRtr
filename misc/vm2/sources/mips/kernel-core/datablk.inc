;------------------------------- kernel info...
kernel_id1:
db 'name: BugOS Kernel',13,10
db 'version: 2.0',13,10
db 'date: ',%date,13,10
db 'time: ',%time,13,10
db 'coder: Mc',13,10
db 0
;------------------------------- kernel logo...
kernel_id2:
db 'ßÛÛßßÛÜ   Coded by Mc   ÜÛßßßÛÜ ÜÛßßßÛÜ',13,10
db ' ÛÛ  ÛÛ ÜÜ  ÜÜ   ÜÜÜ ÜÜ ÛÛ   ÛÛ ßÛÜ  ßß',13,10
db ' ÛÛßßÛÜ ÛÛ  ÛÛ  ÛÛ  ÛÛ  ÛÛ   ÛÛ   ßßÛÜ',13,10
db ' ÛÛ  ÛÛ ÛÛ  ÛÛ  ÛÛ  ÛÛ  ÛÛ   ÛÛ ÜÜ   ÛÛ',13,10
db 'ÜÛÛÜÜÛß ßÛÜÜßÛÜ ßÛÜÜÛÛ  ßÛÜÜÜÛß ßÛÜÜÜÛß',13,10
db '                ÜÜ  ÛÛ',13,10
db '                 ßßßß      Kernel v2.0',13,10
db 0
;-------------------------------

;------------------------------- general texts...
textCRLF db 13,10,0
text001 db '0123456789ABCDEF',0
text002 db 'error: ',0
text003 db 'unwanted exception!',0
text004 db 'going to reboot...',0
text005 db 'exception: #',0
text006 db ': ',0
text007 db 13,10,'pid=',0
text008 db '  par=',0
text009 db '  uid=',0
text010 db '  rgt=',0
text011 db 13,10,'pathname="',0
text012 db '"',13,10,'parameter="',0
text013 db '"',13,10,0
text014 db '@',driveSeparatorChar,pathSeparatorChar,'startupRamDrive.Code',0
text015 db '@',driveSeparatorChar,pathSeparatorChar,'ramDriveStarter.Code',0
text016 db '@',driveSeparatorChar,pathSeparatorChar,0
;------------------------------- exception names...
textExLst:
dd offset textEx00,offset textEx01,offset textEx02,offset textEx03
dd offset textEx04,offset textEx05,offset textEx06,offset textEx07
dd offset textEx08,offset textEx09,offset textEx10,offset textEx11
dd offset textEx12,offset textEx13,offset textEx14,offset textEx15
dd offset textEx16,offset textEx17,offset textEx18,offset textEx19
dd offset textEx20,offset textEx21,offset textEx22,offset textEx23
dd offset textEx24,offset textEx25,offset textEx26,offset textEx27
dd offset textEx28,offset textEx29,offset textEx30,offset textEx31
textEx00 db 'interrupt',0
textEx01 db 'tlb modify',0
textEx02 db 'tlb error on load',0
textEx03 db 'tlb error on store',0
textEx04 db 'address error on load',0
textEx05 db 'address error on store',0
textEx06 db 'bus error on load',0
textEx07 db 'bus error on store',0
textEx08 db 'syscall',0
textEx09 db 'breakpoint',0
textEx10 db 'reserved instruction',0
textEx11 db 'coprocessor unusable',0
textEx12 db 'arithmetic overflow',0
textEx13 db 'trap',0
textEx19:
textEx20:
textEx21:
textEx25:
textEx26:
textEx27:
textEx28:
textEx29:
textEx31:
textEx14 db 'unknown',0
textEx15 db 'floating point',0
textEx16 db 'coprocessor implementation',0
textEx17 db 'core extension unusable',0
textEx18 db 'coprocessor precise',0
textEx22 db 'mdmx unusable',0
textEx23 db 'reference to watch',0
textEx24 db 'matchine check',0
textEx30 db 'cache error',0
;------------------------------- register names...
textRg03 db 13,10,'a0=',0
textRg04 db '  a1=',0
textRg05 db '  a2=',0
textRg06 db '  a3=',0
textRg07 db 13,10,'t0=',0
textRg08 db '  t1=',0
textRg09 db '  t2=',0
textRg10 db '  t3=',0
textRg11 db 13,10,'t4=',0
textRg12 db '  t5=',0
textRg13 db '  t6=',0
textRg14 db '  t7=',0
textRg23 db 13,10,'t8=',0
textRg24 db '  t9=',0
textRg01 db '  v0=',0
textRg02 db '  v1=',0
textRg15 db 13,10,'s0=',0
textRg16 db '  s1=',0
textRg17 db '  s2=',0
textRg18 db '  s3=',0
textRg19 db 13,10,'s4=',0
textRg20 db '  s5=',0
textRg21 db '  s6=',0
textRg22 db '  s7=',0
textRg27 db 13,10,'s8=',0
textRg00 db '  at=',0
textRg25 db '  gp=',0
textRg26 db '  sp=',0
textRg28 db 13,10,'ra=',0
textRg29 db '  pc=',0
textRg30 db '  hi=',0
textRg31 db '  lo=',0
;-------------------------------

;------------------------------- init process binary...
align 4
initProcess_beg:
incbin initproc.code
initProcess_end:
align 4
;------------------------------- general constants...
MemoryTestBlock equ 100000h     ;memory test block size...
KernelProcNum equ 0ffffffffh    ;kernel's process number...
AdminUserNum equ 0              ;administrator's uid...
pathSeparatorChar equ 92        ;the path separator char: '\'...
driveSeparatorChar equ 58       ;the drive separator char: ':'...
TimerClicksPerSec equ 32        ;timer clicks per second...
TimerInterruptNum equ 7         ;timer interrupt number...
ComparatorValue equ 1000000h    ;comparer register value...
tlbEntryMax equ 16              ;number of tlb entries...
;------------------------------- memory constants...
KernelPhyOfs equ 8000h          ;kernel's physical offset...
KernelLogOfs equ 80008000h      ;kernel's logical offset...
RestartOfs equ 0bfc00000h       ;system restart offset...
KernelBufOfs equ 80001000h      ;16k free buffer space...
ramDriveMaxSiz equ 200000h      ;ram drive offset from kernel...
irqHookingTable dd 16 dup (0)   ;irq hook table...
driveHookTable dd 512 dup (0)   ;drive hook table...
ProcessorText db 16 dup (0)     ;cpu name and revision...
ProcessorCode dd 0              ;cpu identification...
LastIRQenaMap dd 0              ;last interrupt enable map...
KernelBigBuf dd 0               ;96k free buffer space...
TotalMemByt dd 0                ;total bytes available...
TotalMemPag dd 0                ;total pages available...
MemAllocOfs dd 0                ;memory usage table...
ExcpHndlOfs dd 0                ;exception/interrupt handler...
FirstPipeOfs dd 0               ;first pipeline offset...
FirstFileOfs dd 0               ;first file offset...
FirstProcOfs dd 0               ;first process offset...
TicksPerOneDay dd 0             ;ticks occuring in one day...
StartupPastTick dd 0            ;ticks past since startup...
StartupPastDays dd 0            ;days past since startup...
CurrProcOfs dd KernelBufOfs     ;current process descriptor...
CurrProcPid dd 0                ;current process id...
NextIdTryGiv dd 0               ;next id to try to give...
NextTlbWrte dd 0                ;next tlb to overwrite...
TotProcStrt dd 0                ;total number of process starts...
TotFrstStrt dd 0                ;total number of first process starts...
ActiveDriveDsk dd 0             ;active drive disk process id...
ActiveDriveUsr dd 0             ;active drive user process id...
ActiveDriveDsc dd 0             ;active drive user descriptor...
ActiveDriveTim dd 0             ;active drive tim started...
ActiveDriveBuf dd 0             ;active drive buffer offset...
ActiveDriveSrc dd 0             ;active drive source offset...
ActiveDriveTrg dd 0             ;active drive target offset...
ActiveDriveSiz dd 0             ;active drive bytes to copy...
ActiveDriveHnd dd 0             ;active drive handler number...
ActiveDriveHnO dd 0             ;active drive handler offset...
ActiveDriveCmd dd 0             ;active drive command issued...
ActiveDriveRgt dd 0             ;active drive rights...
;------------------------------- listing layout...
listing_idnt equ 00h            ;dd: id...
listing_next equ 04h            ;dd: next descriptor...
listing_prev equ 08h            ;dd: previous descriptor...
;------------------------------- pipeline list layout...
pipeLst_plid equ 00h            ;dd: pipeline id...
pipeLst_next equ 04h            ;dd: next pipeline descriptor...
pipeLst_prev equ 08h            ;dd: previous pipeline descriptor...
pipeLst_size equ 0ch            ;dw: size of pipeline in pages...
pipeLst_blck equ 0eh            ;db: block mode pipeline...
pipeLst_begS equ 10h            ;dd: offset of send (c->a) buffer...
pipeLst_begR equ 14h            ;dd: offset of receive (a->c) buffer...
pipeLst_sizS equ 18h            ;dd: size of send (c->a) buffer...
pipeLst_sizR equ 1ch            ;dd: size of receive (a->c) buffer...
pipeLst_posS equ 20h            ;dd: position in send (c->a) buffer...
pipeLst_posR equ 24h            ;dd: position in receive (a->c) buffer...
pipeLst_pidC equ 28h            ;dd: caller's pid...
pipeLst_pidA equ 2ch            ;dd: answerer's pid...
pipeLst_phys equ 30h            ;dd: physical offset...
pipeLst__hed equ 34h            ;size of header...
pipeLst__siz equ 8000h          ;size of structure in bytes...
;------------------------------- irq hook entry layout...
irqHook_pid equ 00h             ;dd: process id...
irqHook_pc equ 04h              ;dd: entering pc value...
irqHook__siz equ 08h            ;size of structure...
;------------------------------- drive list layout...
driveLst_pid equ 00h            ;dd: process id...
driveLst_buf equ 04h            ;dd: shared buffer offset...
driveLst__siz equ 08h           ;size of structure...
;------------------------------- drive buffer layout...
drvBuf_cmd equ 000h             ;dd: command/result code...
drvBuf_usr equ 004h             ;dd: user who wants to do...
drvBuf_rgt equ 008h             ;dd: rights what user wants to do...
drvBuf_siz equ 00ch             ;dd: buffer size...
drvBuf_dir equ 010h             ;256: current directory...
drvBuf_fn1 equ 110h             ;256: pathname #1...
drvBuf_fn2 equ 210h             ;256: pathname #2...
drvBuf_hdr equ 310h             ;512: file handle...
drvBuf_dat equ 510h             ;64k: data buffer...
drvBuf__siz equ 10510h          ;size of structure...
;------------------------------- open file list layout...
fileLst_hdr equ 000h            ;dd: file handler...
fileLst_nxt equ 004h            ;dd: next handler offset...
fileLst_prv equ 00ch            ;dd: previous handler offset...
fileLst_pid equ 010h            ;dd: process id...
fileLst_rgt equ 014h            ;dd: access rights...
fileLst_drv equ 018h            ;dd: pid of drive process...
fileLst_ind equ 01ch            ;dd: inode of file...
fileLst_buf equ 020h            ;dd: drive buffer...
fileLst_dat equ 100h            ;512: file data...
fileLst__siz equ 300h           ;size of structure...
;------------------------------- rights...
rights_ownRead equ 01h          ;owner can read...
rights_ownWrite equ 02h         ;owner can write...
rights_ownExec equ 04h          ;owner can execute...
rights_anyRead equ 08h          ;everybody can read...
rights_anyWrite equ 10h         ;everybody can write...
rights_anyExec equ 20h          ;everybody can execute...
rights_rootPriv equ 40h         ;has root privileges (can do tricks;)
rights_directory equ 80h        ;this is a directory...
rights_allowRead equ 100h       ;allow simultaneous read...
rights_allowWrite equ 200h      ;allow simultaneous write...
rights_allowExec equ 400h       ;allow simultaneous execution...
;------------------------------- system drive commands...
sysDrvCmd_chgDir equ 001h       ;change directory...
sysDrvCmd_statst equ 002h       ;drive statistics...
sysDrvCmd_makDir equ 003h       ;create directory...
sysDrvCmd_delDir equ 004h       ;erase directory...
sysDrvCmd_makFil equ 005h       ;create file...
sysDrvCmd_delFil equ 006h       ;erase file...
sysDrvCmd_rename equ 007h       ;rename...
sysDrvCmd_mkLink equ 008h       ;make link...
sysDrvCmd_stRigt equ 009h       ;set rights...
sysDrvCmd_stDate equ 00Ah       ;set date...
sysDrvCmd_drOpen equ 20Bh       ;open directory...
sysDrvCmd_drRead equ 10Ch       ;read directory...
sysDrvCmd_flOpen equ 20Dh       ;open file...
sysDrvCmd_flRead equ 10Eh       ;read file
sysDrvCmd_flWrte equ 00Fh       ;write file...
sysDrvCmd_flSeek equ 010h       ;seek file...
sysDrvCmd_flSize equ 011h       ;get file size...
sysDrvCmd_flPosi equ 012h       ;get file pos...
sysDrvCmd_flTrnc equ 013h       ;truncate file...
;------------------------------- error codes....
error_none equ 0                ;no error...
error_default equ 1             ;unknown error...
error_memSpace equ 2            ;out of memory...
error_diskSpace equ 3           ;out of disk space...
error_noRight equ 4             ;no right...
error_sharing equ 5             ;sharing violation...
error_noPath equ 6              ;path not exists...
error_notExists equ 7           ;file not exists...
error_already equ 8             ;file already exists...
error_handler equ 9             ;invalid handle...
error_dirNotEmpty equ 10        ;directory not empty...
error_dirEmbedded equ 11        ;embedded directories...
error_dirMismatch equ 12        ;file/directory mismatch...
error_pointerBig equ 13         ;file pointer too big...
error_ioFault equ 14            ;drive io fault...
error_drvNotRedy equ 15         ;drive not ready...
error_endOfFile equ 16          ;eof encountered...
error_badName equ 17            ;invalid filename format...
error_badTermin equ 18          ;abnormal program termination...
;------------------------------- process status...
status_running equ 0            ;up and running...
status_initial equ 1            ;under initialization...
status_fileio equ 2             ;fileio pending...
status_wait4exec equ 3          ;execute pending...
;------------------------------- executable header layout...
execHdr_idntfy equ 00h          ;dd: executable identifier...
execHdr_codSiz equ 04h          ;dd: code size in bytes...
execHdr_datSiz equ 08h          ;dd: data size in bytes...
execHdr_stkSiz equ 0ch          ;dd: stack size in bytes...
execHdr__siz equ 10h            ;size of structure...
execHdr__idv equ 65786563h      ;executable identifier value...
;------------------------------- process stack data layout...
procStk_pid equ 000h            ;dd: process id...
procStk_next equ 004h           ;dd: next process offset...
procStk_prev equ 008h           ;dd: previous process offset...
procStk_ppid equ 00ch           ;dd: parent process id...
procStk_cuid equ 010h           ;dd: current user id...
procStk_ouid equ 014h           ;dd: original user id...
procStk_right equ 018h          ;dd: rights...
procStk_codeSize equ 01ch       ;dd: code size in bytes...
procStk_stakSize equ 020h       ;dd: stack size in bytes...
procStk_dataSize equ 024h       ;dd: data size in bytes...
procStk_pathName equ 028h       ;256: process pathname...
procStk_paramStr equ 128h       ;256: parameter string...
procStk_currDir equ 228h        ;256: current directory...
procStk_lastReleq equ 328h      ;dd: ticks since last control giveaway...
procStk_status equ 32ch         ;db: status of process...
procStk_oldStat equ 32dh        ;db: old status of process...
procStk_rentCon equ 330h        ;dd: console owner process id...
procStk_console equ 334h        ;dd: pipeline of console...
procStk_listen equ 338h         ;dd: pipeline of listening...
procStk_execWait equ 33ch       ;dd: waiting for this pid...
procStk_missdIrq equ 340h       ;dd: number of missed irqs...
procStk_mapdSize equ 344h       ;dd: mapped data size in pages...
procStk_mapVoffs equ 348h       ;dd: mapped data virtual page offset...
procStk_mapPoffs equ 34ch       ;dd: mapped data physical page offset...
procStk_reg_at equ 350h         ;dd: at register...
procStk_reg_v0 equ 354h         ;dd: v0 register...
procStk_reg_v1 equ 358h         ;dd: v1 register...
procStk_reg_a0 equ 35ch         ;dd: a0 register...
procStk_reg_a1 equ 360h         ;dd: a1 register...
procStk_reg_a2 equ 364h         ;dd: a2 register...
procStk_reg_a3 equ 368h         ;dd: a3 register...
procStk_reg_t0 equ 36ch         ;dd: t0 register...
procStk_reg_t1 equ 370h         ;dd: t1 register...
procStk_reg_t2 equ 374h         ;dd: t2 register...
procStk_reg_t3 equ 378h         ;dd: t3 register...
procStk_reg_t4 equ 37ch         ;dd: t4 register...
procStk_reg_t5 equ 380h         ;dd: t5 register...
procStk_reg_t6 equ 384h         ;dd: t6 register...
procStk_reg_t7 equ 388h         ;dd: t7 register...
procStk_reg_s0 equ 38ch         ;dd: s0 register...
procStk_reg_s1 equ 390h         ;dd: s1 register...
procStk_reg_s2 equ 394h         ;dd: s2 register...
procStk_reg_s3 equ 398h         ;dd: s3 register...
procStk_reg_s4 equ 39ch         ;dd: s4 register...
procStk_reg_s5 equ 3a0h         ;dd: s5 register...
procStk_reg_s6 equ 3a4h         ;dd: s6 register...
procStk_reg_s7 equ 3a8h         ;dd: s7 register...
procStk_reg_t8 equ 3ach         ;dd: t8 register...
procStk_reg_t9 equ 3b0h         ;dd: t9 register...
procStk_reg_gp equ 3b4h         ;dd: gp register...
procStk_reg_sp equ 3b8h         ;dd: sp register...
procStk_reg_s8 equ 3bch         ;dd: s8 register...
procStk_reg_ra equ 3c0h         ;dd: ra register...
procStk_reg_pc equ 3c4h         ;dd: pc register...
procStk_reg_hi equ 3c8h         ;dd: hi register...
procStk_reg_lo equ 3cch         ;dd: lo register...
procStk_pageSize equ 3d0h       ;dd: pagetable entries available...
procStk_pageDefS equ 3d4h       ;dd: pagetable default size...
procStk_irqRetPc equ 3d8h       ;dd: irq return pc value...
procStk_irqRetT0 equ 3dch       ;dd: irq return t0 value...
procStk_timesRun equ 3e0h       ;dd: times process started...
procStk__siz equ 3e4h           ;size of structure, pagetable follows...
;-------------------------------
