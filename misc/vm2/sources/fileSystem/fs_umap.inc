Function BitmapWriteValue(n:numberType;s:Boolean):Word;
Var
  sec:OneSectorRecord;
  i,o:numberType;
  w:Word;
Begin;
o:=n mod BitsPerSector;
n:=(n div BitsPerSector)+DriveBitmap;
i:=1 shl (o mod BitsPerOneByte);
o:=(o div BitsPerOneByte)+1;
w:=CacheRead(n,sec);
if (w<>0) then begin; BitmapWriteValue:=w;exit; end;
if s then begin;
  if (sec[o] and i<>0) then begin; BitmapWriteValue:=0;exit; end;
  sec[o]:=sec[o] or i;
  end else begin;
  if (sec[o] and i=0) then begin; BitmapWriteValue:=0;exit; end;
  sec[o]:=sec[o] and (not i);
  end;
w:=CacheWrite(n,sec);
BitmapWriteValue:=w;
End;

Function BitmapReadValue(n:numberType;var s:Boolean):Word;
Var
  sec:OneSectorRecord;
  i,o:numberType;
  w:Word;
Begin;
o:=n mod BitsPerSector;
n:=(n div BitsPerSector)+DriveBitmap;
i:=1 shl (o mod BitsPerOneByte);
o:=(o div BitsPerOneByte)+1;
w:=CacheRead(n,sec);
BitmapReadValue:=w;
s:=(sec[o] and i<>0);
End;

Function BitmapFindEmpty(var n:numberType):Word;
Var
  sec:OneSectorRecord;
  i,o,p:numberType;
  w:Word;
Begin;
for i:=1 to (DriveSize+BitsPerSector-1) div BitsPerSector do begin;
  w:=CacheRead(DriveBitmap+DriveLastMap,sec);
  if (w<>0) then begin; BitmapFindEmpty:=w;exit; end;
  for o:=1 to BytesPerSector do begin;
    if (sec[o]=$ff) then continue;
    p:=sec[o];
    for w:=0 to BitsPerOneByte-1 do if ((1 shl w) and p=0) then begin;
      n:=DriveLastMap*BitsPerSector+(o-1)*BitsPerOneByte+w;
      BitmapFindEmpty:=0;
      exit;
      end;
    end;
  inc(DriveLastMap);
  if (DriveLastMap>=(DriveSize+BitsPerSector-1) div BitsPerSector) then DriveLastMap:=0;
  end;
BitmapFindEmpty:=3;
End;


Function BitmapCountDiskUsage(var free,used,bad,blockSize:numberType):Word;
Var
  usedBits:array[0..255] of Byte;
  sec:OneSectorRecord;
  i,o,p:numberType;
  w:Word;
Begin;
for p:=0 to 255 do begin;
  o:=0;
  for i:=0 to BitsPerOneByte-1 do if ((1 shl i) and p<>0) then inc(o);
  usedBits[p]:=o;
  end;
used:=0;
free:=0;
bad:=0;
for i:=1 to (DriveSize+BitsPerSector-1) div BitsPerSector do begin;
  w:=CacheRead(DriveBitmap+i-1,sec);
  if (w<>0) then begin; BitmapCountDiskUsage:=w;exit; end;
  for o:=1 to BytesPerSector do begin;
    p:=usedBits[sec[o]];
    inc(used,p);
    inc(free,8-p);
    end;
  end;
p:=used+free;
if (p>DriveSize) then dec(used,p-DriveSize);
blockSize:=BytesPerSector;
BitmapCountDiskUsage:=0;
End;
