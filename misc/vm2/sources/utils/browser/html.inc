Procedure decodeCurrentHtml(var t:xtText);
Label f1,f2,vege;
Var
  i,o:LongInt;
  a,b,c,d:String;
  s:String;
  sb:array[0..1] of byte absolute s;
  sb0:byte absolute s;
  sa:Boolean;
  lc:LongInt;
  fa:Boolean;
  tc:LongInt;
  tag:oneTagRecord;
  tt:xtText;

Procedure flush;
Begin;
outputAddText(s);
sb0:=0;
End;

Procedure putCrLf;
Begin;
flush;
outputWriteBuf;
outputAddColor(currentCol);
repeat
  i:=xtGetOneChar(t);
  if (i in [0..31]) then i:=32;
  until (i<>32);
xtUndoLastRead(t);
End;

Function readUntilTag:String;
Label f1,f2;
Var
  a:String;
  ab:array[0..1] of byte absolute a;
  ab0:byte absolute a;
Begin;
ab0:=0;
f1:
i:=xtGetOneChar(t);
if (i=38) then begin;
  i:=readUpOneQuoted(t);
  if (i<0) then goto f1;
  end else begin;
  if (i<0) then goto f2;
  if (i in [0..31]) then i:=32;
  if sa and (i=32) then begin;
    if (ab[ab0]=32) then goto f1;
    if (ab0=0) then goto f1;
    end;
  if (i=60) then begin; xtUndoLastRead(t);goto f2; end;
  end;
if (ab0>250) then goto f1;
inc(ab0);
ab[ab0]:=i;
goto f1;
f2:
readUntilTag:=a;
End;


Begin;
outputAddColor(currentCol);
sa:=true;
lc:=0;
fa:=false;
tc:=0;
sb0:=0;
f1:
if (sb0>240) then begin;
  i:=findLastSpace(s);
  if (i<=0) then i:=sb0;
  a:=copy(s,i+1,666);
  sb0:=i;
  flush;
  s:=a;
  end;
i:=xtGetOneChar(t);
if (i<0) then goto vege;
if sa then begin;
  if (i in [0..31]) then i:=32;
  end else begin;
  if (i=9) then begin;
    inc(sb0);
    sb[sb0]:=32;
    while (sb0 and 7<>0) do begin;
      inc(sb0);
      sb[sb0]:=32;
      end;
    goto f1;
    end;
  if (i in [13,10]) then begin;
    xtUndoLastRead(t);
    s:=s+xtReadLn(t,666);
    putCrLf;
    goto f1;
    end;
  end;
if (i=38) then begin;
  i:=readUpOneQuoted(t);
  if (i<0) then goto f1;
  goto f2;
  end;
if (i<>60) then begin;
  if sa and (i=32) then begin;
    if (sb[sb0]=32) then goto f1;
    end;
  f2:
  inc(sb0);
  sb[sb0]:=i;
  goto f1;
  end;
readUpOneTag(t,tag);
a:=tag.t;
if (a='!--') then goto f1;
if (a='!doctype') then goto f1;
if (a='html') then goto f1;
if (a='/html') then goto f1;
if (a='head') then begin;
  flush;
  outputAddLink(getOneTagValue(tag,'profile'),'meta-data');
  goto f1;
  end;
if (a='/head') then goto f1;
if (a='title') then begin;
  currentTit:=readUntilTag;
  goto f1;
  end;
if (a='/title') then goto f1;
if (a='meta') then begin;
  if (kicsi(getOneTagValue(tag,'http-equiv'))<>'refresh') then goto f1;
  a:=getOneTagValue(tag,'content');
  i:=pos('=',a);
  if (i>0) then a:=copy(a,i+1,666);
  s:=s+' ';
  flush;
  outputAddLink(a,'refresh');
  s:=s+' ';
  goto f1;
  end;
if (a='body') then begin;
  flush;
  outputAddLink(getOneTagValue(tag,'background'),'bg-img');
  goto f1;
  end;
if (a='/body') then goto f1;
if (a='div') or (a='span') then begin;
  a:=getOneTagValue(tag,'title');
  if (a<>'') then a:=':'+a;
  flush;
  outputAddLink(getOneTagValue(tag,'datasrc'),'div'+a);
  goto f1;
  end;
if (a='/div') or (a='/span') then goto f1;
if (a='h1') or (a='h2') or (a='h3') or (a='h4') or (a='h5') or (a='h6') then begin; putCrLf;goto f1; end;
if (a='/h1') or (a='/h2') or (a='/h3') or (a='/h4') or (a='/h5') or (a='/h6') then begin; putCrLf;goto f1; end;
if (a='address') then goto f1;
if (a='/address') then goto f1;
if (a='bdo') then goto f1;
if (a='/bdo') then goto f1;
if (a='em') or (a='strong') or (a='dfn') or (a='code') or (a='samp') or (a='kbd') or (a='var') or (a='cite') then goto f1;
if (a='/em') or (a='/strong') or (a='/dfn') or (a='/code') or (a='/samp') or (a='/kbd') or (a='/var') or (a='/cite') then goto f1;
if (a='abbr') or (a='acronym') then begin;
  a:=getOneTagValue(tag,'title');
  if (a='') then goto f1;
  flush;
  s:=s+' '+a+'=';
  goto f1;
  end;
if (a='/abbr') or (a='/acronym') then goto f1;
if (a='blockquote') or (a='q') then begin;
  a:=getOneTagValue(tag,'title');
  if (a<>'') then a:=':'+a;
  flush;
  outputAddLink(getOneTagValue(tag,'cite'),'quote'+a);
  s:=s+'"';
  goto f1;
  end;
if (a='/blockquote') or (a='/q') then begin;
  s:=s+'"';
  goto f1;
  end;
if (a='sub') or (a='sup') then goto f1;
if (a='/sub') or (a='/sup') then goto f1;
if (a='p') or (a='/p') or (a='br') then begin; putCrLf;goto f1; end;
if (a='pre') then begin; putCrLf;sa:=false;goto f1; end;
if (a='/pre') then begin; putCrLf;sa:=true;goto f1; end;
if (a='ins') or (a='del') then begin;
  a:=getOneTagValue(tag,'title');
  if (a<>'') then a:=':'+a;
  flush;
  outputAddLink(getOneTagValue(tag,'cite'),'change'+a);
  goto f1;
  end;
if (a='/ins') or (a='/del') then goto f1;
if (a='lh') or (a='/lh') then goto f1;
if (a='ul') then begin; lc:=1;goto f1; end;
if (a='ol') then begin; lc:=2;goto f1; end;
if (a='/ul') or (a='/ol') then begin; lc:=0;goto f1; end;
if (a='li') then case lc of
  0:goto f1;
  1:begin;
    putCrLf;
    outputAddColor(8);
    s:=s+'*';
    flush;
    outputAddColor(currentCol);
    goto f1;
    end;
  else begin;
    inc(lc);
    putCrLf;
    outputAddColor(8);
    s:=s+BStr(lc-2)+':';
    flush;
    outputAddColor(currentCol);
    goto f1;
    end;
  end;
if (a='/li') then goto f1;
if (a='dl') then goto f1;
if (a='dt') then begin; putCrLf;goto f1; end;
if (a='dd') then begin; s:=s+'=';goto f1; end;
if (a='/dl') or (a='/dt') or (a='/dd') then goto f1;
if (a='table') or (a='/table') then begin; putCrLf;goto f1; end;
if (a='caption') or (a='/caption') then goto f1;
if (a='thead') or (a='tbody') or (a='tfoot') or (a='/thead') or (a='/tbody') or (a='/tfoot') then goto f1;
if (a='tr') then begin;
  putCrLf;
  outputAddColor(8);
  s:=s+'|';
  flush;
  outputAddColor(currentCol);
  goto f1;
  end;
if (a='/tr') then goto f1;
if (a='td') or (a='th') then goto f1;
if (a='/td') or (a='/th') then begin;
  i:=(outputChr+sb0) and 7;
  s:=s+copy('          ',1,8-i);
  flush;
  outputAddColor(8);
  s:=s+'|';
  flush;
  outputAddColor(currentCol);
  goto f1;
  end;
if (a='colgroup') or (a='col') or (a='/colgroup') or (a='/col') then goto f1;
if (a='a') then begin;
  a:=readUntilTag;
  if (a='') then a:='lnk';
  flush;
  outputAddLink(getOneTagValue(tag,'href'),a);
  goto f1;
  end;
if (a='/a') then goto f1;
if (a='link') then begin;
  a:=getOneTagValue(tag,'rel');
  if (a='') then a:=getOneTagValue(tag,'rev');
  if (a<>'') then a:=':'+a;
  flush;
  outputAddLink(getOneTagValue(tag,'href'),'link'+a);
  goto f1;
  end;
if (a='base') then begin;
  a:=convertUrlString(getOneTagValue(tag,'href'));
  if (a<>'') then currentBas:=a;
  goto f1;
  end;
if (a='img') then begin;
  a:=getOneTagValue(tag,'alt');
  if (a<>'') then a:=':'+a;
  flush;
  outputAddLink(getOneTagValue(tag,'src'),'img'+a);
  outputAddLink(getOneTagValue(tag,'longdesc'),'img-dsc'+a);
  outputAddLink(getOneTagValue(tag,'usemap'),'img-map'+a);
  goto f1;
  end;
if (a='bgsound') then begin;
  a:=getOneTagValue(tag,'title');
  if (a<>'') then a:=':'+a;
  flush;
  outputAddLink(getOneTagValue(tag,'src'),'snd'+a);
  goto f1;
  end;
if (a='object') then begin;
  a:=getOneTagValue(tag,'title');
  if (a<>'') then a:=':'+a;
  flush;
  outputAddLink(getOneTagValue(tag,'classid'),'object'+a);
  outputAddLink(getOneTagValue(tag,'data'),'obj-dat'+a);
  outputAddLink(getOneTagValue(tag,'usemap'),'obj-map'+a);
  goto f1;
  end;
if (a='/object') then goto f1;
if (a='applet') then begin;
  a:=getOneTagValue(tag,'alt');
  if (a<>'') then a:=':'+a;
  flush;
  outputAddLink(getOneTagValue(tag,'code'),'applet'+a);
  goto f1;
  end;
if (a='/applet') then goto f1;
if (a='embed') then begin;
  a:=getOneTagValue(tag,'alt');
  if (a<>'') then a:=':'+a;
  flush;
  outputAddLink(getOneTagValue(tag,'src'),'embed'+a);
  goto f1;
  end;
if (a='/embed') then goto f1;
if (a='param') then begin;
  a:=kicsi(getOneTagValue(tag,'valuetype'));
  if (a<>'ref') and (a<>'object') then goto f1;
  flush;
  outputAddLink(getOneTagValue(tag,'value'),'param');
  goto f1;
  end;
if (a='map') or (a='/map') then goto f1;
if (a='area') then begin;
  a:=getOneTagValue(tag,'alt');
  if (a<>'') then a:=':'+a;
  flush;
  outputAddLink(getOneTagValue(tag,'href'),'map'+a);
  goto f1;
  end;
if (a='style') or (a='/style') then goto f1;
if (a='blink') or (a='tt') or (a='big') or (a='small') or (a='strike') or (a='s') then goto f1;
if (a='/blink') or (a='/tt') or (a='/big') or (a='/small') or (a='/strike') or (a='/s') then goto f1;
if (a='i') then begin;
  currentCol:=(currentCol and 8) or 6;
  flush;
  outputAddColor(currentCol);
  goto f1;
  end;
if (a='u') then begin;
  currentCol:=(currentCol and 8) or 5;
  flush;
  outputAddColor(currentCol);
  goto f1;
  end;
if (a='b') then begin;
  currentCol:=currentCol or 15;
  flush;
  outputAddColor(currentCol);
  goto f1;
  end;
if (a='/u') or (a='/i') then begin;
  currentCol:=(currentCol and 8) or 7;
  flush;
  outputAddColor(currentCol);
  goto f1;
  end;
if (a='/b') then begin;
  currentCol:=currentCol and 7;
  flush;
  outputAddColor(currentCol);
  goto f1;
  end;
if (a='hr') then begin;
  putCrLf;
  outputAddColor(9);
  fillchar(s,sizeof(s),45);
  sb0:=screenSizX;
  putCrLf;
  goto f1;
  end;
if (a='basefont') or (a='font') or (a='/font') then goto f1;
if (a='spacer') then goto f1;
if (a='nobr') or (a='/nobr') then goto f1;
if (a='center') or (a='/center') then goto f1;
if (a='comment') or (a='/comment') then goto f1;
if (a='dir') or (a='/dir') then goto f1;
if (a='menu') or (a='/menu') then goto f1;
if (a='frameset') or (a='/frameset') then goto f1;
if (a='marquee') then begin;
  a:=getOneTagValue(tag,'title');
  if (a<>'') then a:=':'+a;
  flush;
  outputAddLink(getOneTagValue(tag,'datasrc'),'mrq'+a);
  goto f1;
  end;
if (a='/marquee') then goto f1;
if (a='frame') then begin;
  a:=getOneTagValue(tag,'name');
  if (a<>'') then a:=':'+a;
  flush;
  outputAddLink(getOneTagValue(tag,'longdesc'),'frm-dsc'+a);
  outputAddLink(getOneTagValue(tag,'src'),'frame'+a);
  goto f1;
  end;
if (a='noframes') or (a='/noframes') then goto f1;
if (a='iframe') then begin;
  a:=getOneTagValue(tag,'name');
  if (a<>'') then a:=':'+a;
  flush;
  outputAddLink(getOneTagValue(tag,'longdesc'),'frm-dsc'+a);
  outputAddLink(getOneTagValue(tag,'src'),'iframe'+a);
  goto f1;
  end;
if (a='/iframe') then goto f1;
if (a='layer') then begin;
  a:=getOneTagValue(tag,'name');
  if (a<>'') then a:=':'+a;
  flush;
  outputAddLink(getOneTagValue(tag,'background'),'lyr-img');
  outputAddLink(getOneTagValue(tag,'src'),'layer'+a);
  goto f1;
  end;
if (a='/layer') then goto f1;
if (a='form') then begin;
  flush;
  if fa then outputAddFormEnd;
  putCrLf;
  a:=getOneTagValue(tag,'name');
  if (a<>'') then a:=':'+a;
  flush;
  outputAddFormBeg(getOneTagValue(tag,'action'),getOneTagValue(tag,'method'),getOneTagValue(tag,'enctype'),'form'+a);
  fa:=true;
  goto f1;
  end;
if (a='/form') then begin;
  flush;
  outputAddFormEnd;
  fa:=false;
  goto f1;
  end;
if (a='isindex') then goto f1;
if (a='input') then begin;
  b:=getOneTagValue(tag,'alt');
  if (b='') then b:=getOneTagValue(tag,'name');
  if (b<>'') then b:=':'+b;
  s:=s+' ';
  flush;
  outputAddLink(getOneTagValue(tag,'src'),'inp-img'+b);
  outputAddLink(getOneTagValue(tag,'usemap'),'inp-map'+b);
  a:=kicsi(getOneTagValue(tag,'type'));
  c:=getOneTagValue(tag,'name');
  d:=getOneTagValue(tag,'value');
  if (a='submit') then begin;
    b:=getOneTagValue(tag,'value');
    if (b<>'') then b:=':'+b;
    outputAddFormEntry(6,c,d,'submit'+b);
    goto f1;
    end;
  if (a='reset') then begin;
    b:=getOneTagValue(tag,'value');
    if (b<>'') then b:=':'+b;
    outputAddFormEntry(7,c,d,'reset'+b);
    goto f1;
    end;
  if (a='button') then begin;
    b:=getOneTagValue(tag,'value');
    if (b<>'') then b:=':'+b;
    outputAddFormEntry(8,c,d,'button'+b);
    goto f1;
    end;
  if (a='image') then begin;
    if (c<>'') then begin;
      outputAddFormEntry(9,c+'.x','0','inpX'+b);
      outputAddText(' ');
      outputAddFormEntry(9,c+'.y','0','inpY'+b);
      outputAddText(' ');
      end;
    outputAddFormEntry(6,'','','submit'+b);
    goto f1;
    end;
  if (a='') or (a='text') then begin;
    outputAddFormEntry(9,c,d,'text'+b);
    goto f1;
    end;
  if (a='password') then begin;
    outputAddFormEntry(9,c,d,'passwd'+b);
    goto f1;
    end;
  if (a='hidden') then begin;
    outputAddFormEntry(9,c,d,'hidden'+b);
    goto f1;
    end;
  if (a='file') then begin;
    outputAddFormEntry(10,c,d,'file'+b);
    goto f1;
    end;
  if (a='checkbox') then begin;
    if (findOneTagEntry(tag,'checked')>0) then i:=1 else i:=0;
    outputAddFormEntry(11,c,chr(i)+d,'[?] chkbox'+b);
    goto f1;
    end;
  if (a='radio') then begin;
    if (findOneTagEntry(tag,'checked')>0) then i:=1 else i:=0;
    outputAddFormEntry(12,c,chr(i)+d,'(?) radio'+b);
    goto f1;
    end;
  writeln('unknown (input) subtag: '+a);
  goto f1;
  end;
if (a='button') then begin;
  b:=getOneTagValue(tag,'value');
  if (b='') then b:=getOneTagValue(tag,'name');
  if (b<>'') then b:=':'+b;
  s:=s+' ';
  flush;
  a:=kicsi(getOneTagValue(tag,'type'));
  c:=getOneTagValue(tag,'name');
  d:=getOneTagValue(tag,'value');
  if (a='submit') then begin;
    outputAddFormEntry(6,c,d,'submit'+b);
    goto f1;
    end;
  if (a='reset') then begin;
    outputAddFormEntry(7,c,d,'reset'+b);
    goto f1;
    end;
  if (a='button') or (a='') then begin;
    outputAddFormEntry(8,c,d,'button'+b);
    goto f1;
    end;
  writeln('unknown (button) subtag: '+a);
  goto f1;
  end;
if (a='/button') then goto f1;
if (a='select') then begin;
  b:=getOneTagValue(tag,'name');
  if (b<>'') then b:=':'+b;
  s:=s+' ';
  flush;
  c:=getOneTagValue(tag,'name');
  if (findOneTagEntry(tag,'multiple')>0) then i:=1 else i:=0;
  outputAddFormEntry(13,chr(i)+c,'','select'+b);
  goto f1;
  end;
if (a='/select') then begin;
  flush;
  outputAddFormEntry(14,'','','');
  goto f1;
  end;
if (a='optgroup') then begin;
  flush;
  outputAddFormEntry(15,'--- '+getOneTagValue(tag,'label'),#2,'');
  goto f1;
  end;
if (a='/optgroup') then goto f1;
if (a='option') then begin;
  flush;
  a:=readUntilTag;
  c:=getOneTagValue(tag,'label');
  b:=getOneTagValue(tag,'value');
  if (c='') then c:=a;
  if (b='') then b:=a;
  if (findOneTagEntry(tag,'selected')>0) then i:=1 else i:=0;
  outputAddFormEntry(15,b,chr(i)+c,'');
  goto f1;
  end;
if (a='/option') then goto f1;
if (a='textarea') then begin;
  b:=getOneTagValue(tag,'name');
  if (b<>'') then b:=':'+b;
  s:=s+' ';
  flush;
  inc(tc);
  a:='textarea'+BStr(tc)+'.'+TemporaryExt;
  outputAddFormEntry(16,getOneTagValue(tag,'name'),a,'textarea'+b);
  a:=dataPath+a;
  xErase(a);
  xCreate(a);
  if (xtOpen(tt,a,false)<>0) then immErr('error creating file!');
  while (1=1) do begin;
    i:=xtGetOneChar(t);
    if (i<0) then break;
    if (i=60) then begin; xtUndoLastRead(t);break; end;
    if (i<>38) then begin; xtPutOneChar(tt,i);continue; end;
    i:=readUpOneQuoted(t);
    if (i<0) then continue;
    xtPutOneChar(tt,i);
    end;
  xtClose(tt);
  goto f1;
  end;
if (a='/textarea') then goto f1;
if (a='label') or (a='/label') then goto f1;
if (a='fieldset') or (a='/fieldset') then goto f1;
if (a='legend') or (a='/legend') then goto f1;
if (a='script') then begin;
  a:=getOneTagValue(tag,'type');
  if (a<>'') then a:=':'+a;
  flush;
  outputAddLink(getOneTagValue(tag,'src'),'script'+a);
  goto f1;
  end;
if (a='/script') then goto f1;
if (a='noscript') or (a='/noscript') then goto f1;

writeln('unknown tag: '+a);
goto f1;
vege:
flush;
if fa then outputAddFormEnd;
putCrLf;
End;
