Var
  downloadMethod:LongInt; {1=get, 2=post, 3=put}
  decodingMethod:LongInt; {1-html, 2-ftp, 3-text, 4-binary, 5-directory, 6-bookmark, 7-history, 8-about, 9-gopher}
  downloadedFile:String;

Procedure doDownloadOneFile(fn:String);
Label f1;
Const
  fileExtTxt:String='|text|txt|list|lst|ascii|asc|pas|c|asm|inc|';
  fileExtBin:String='|exe|bin|iso|zip|tgz|gz|gif|jpeg|jpg|';
  fileExtHtm:String='|html|htm|';
  fileExtGop:String='|gopher|gop|';

Function getDownFile:String;
Var
  a:String;
  i:LongInt;
Begin;
a:=copy(currentUrl,8,666);
kicserel('\',#13,a);
kicserel('/','\',a);
kicserel(#13,'/',a);
i:=pos('?',a);
if (i<1) then i:=666;
if (kicsi(copy(a,1,4))<>'http') then i:=666;
getDownFile:=copy(a,1,i-1);
End;

Function getDownExt:String;
Begin;
getDownExt:='|'+kicsi(copy(xFileName(getDownFile,3),2,666))+'|';
End;

Function isThisDir:Boolean;
Var
  i:LongInt;
  a:String;
Begin;
i:=pos(':',currentUrl);
a:=copy(currentUrl,i+3,666);
i:=pos('/',a);
if (i<1) then i:=666;
a:=copy(a,i+1,666);
isThisDir:=(copy(currentUrl,length(currentUrl),666)='/') or (a='');
End;

Procedure collectUserPass;
Var
  a:String;
  i,o,p:LongInt;
Begin;
o:=pos('://',currentUrl);
a:=copy(currentUrl,o+3,666);
i:=pos('/',a);
if (i<1) then i:=666;
a:=copy(a,1,i-1);
p:=pos('@',a);
if (p<1) then exit;
a:=copy(a,1,p-1);
i:=pos(':',a);
if (i<1) then exit;
currentUrl:=copy(currentUrl,1,o+2)+copy(currentUrl,o+p+3,666);
currentUsr:=copy(a,1,i-1);
currentPwd:=copy(a,i+1,666);
End;

Function collectPort(var b:String):String;
Var
  a:string;
  i:LongInt;
Begin;
if (copy(b,1,1)='[') then begin;
  i:=pos(']',b);
  a:=copy(b,2,i-2);
  b:=copy(b,i+1,255);
  end else begin;
  a:='';
  end;
i:=pos(':',b);
if (i<1) then i:=666;
a:=a+copy(b,1,i-1);
b:=copy(b,i+1,666);
if (b<>'') then b:=' '+b;
collectPort:=a;
End;

Var
  a,b,c:String;
  i,o,p:LongInt;
  t:xtText;
  f:xFile;
  w:Word;
Begin;
decodingMethod:=0;
downloadedFile:='';
TextColor(7);
WriteLn('');
WriteLn('downloading content...');
Write('url: "');write(currentUrl);WriteLn('"');
Write('file: "');write(fn);WriteLn('"');
o:=pos('://',currentUrl);
a:=kicsi(copy(currentUrl,1,o-1));
if (a='http') or (a='https') then begin;
  f1:
  collectUserPass;
  downloadedFile:=fn;
  b:=dataPath+TemporaryUrls;
  xErase(b);
  xCreate(b);
  if (xtOpen(t,b,false)<>0) then immErr('error opening file!');
  xtWrite(t,currentUrl);
  xtClose(t);
  a:=dataPath+TemporaryCmds;
  xErase(a);
  xCreate(a);
  if (xtOpen(t,a,false)<>0) then immErr('error opening file!');
  xtWriteLn(t,'browser ('+PrgTxt+' for BugOS)');
  a:=kicsi(copy(currentUrl,1,pos(':',currentUrl)-1));
  if (currentPrx='') then begin;
    if (a='http') then a:='clear' else a:='secure';
    end else begin;
    xtWriteLn(t,'proxy '+currentPrx);
    a:='clear';
    end;
  xtWriteLn(t,a);
  if (currentUsr<>'') then xtWriteLn(t,'user '+currentUsr);
  if (currentPwd<>'') then xtWriteLn(t,'pass '+currentPwd);
  case downloadMethod of
    1:a:='get';
    2:a:='post';
    3:a:='put';
    else a:='get';
    end;
  xtWriteLn(t,'method '+a);
  xtWriteLn(t,'automode 1');
  if (xOpen(f,downloadedFile,xGenFilMod_rw)=0) then begin;
    p:=xFileSize(f);
    xClose(f);
    end else p:=0;
  xtWriteLn(t,'restart '+BStr(p));
  a:=dataPath+TemporaryPost;
  if fileExists(a) then a:=' '+a else a:='';
  xtWriteLn(t,'get2 '+b+' '+downloadedFile+a);
  xtWriteLn(t,'quit');
  xtClose(t);
  xExec(myFavoritHttpClnt,dataPath+TemporaryCmds,w);
  a:=getDownExt;
  decodingMethod:=1;
  if (pos(a,fileExtTxt)<>0) then decodingMethod:=3;
  if (pos(a,fileExtBin)<>0) then decodingMethod:=4;
  exit;
  end;
if (a='ftp') then begin;
  if (currentPrx<>'') then begin; downloadMethod:=0;goto f1; end;
  collectUserPass;
  downloadedFile:=fn;
  i:=pos(':',currentUrl);
  a:=copy(currentUrl,i+3,666);
  i:=pos('/',a);
  if (i<1) then i:=666;
  b:=copy(a,1,i-1);
  c:=copy(a,i+1,666);
  a:=dataPath+TemporaryUrls;
  xErase(a);
  xCreate(a);
  if (xtOpen(t,a,false)<>0) then immErr('error opening file!');
  xtWrite(t,c);
  xtClose(t);
  a:=dataPath+TemporaryCmds;
  xErase(a);
  xCreate(a);
  if (xtOpen(t,a,false)<>0) then immErr('error opening file!');
  a:=collectPort(b);
  xtWriteLn(t,'connect '+a+b);
  a:=currentUsr;
  b:=currentPwd;
  if (a+b='') then begin; a:='anonymous';b:='browser@bugos'; end;
  xtWriteLn(t,'user '+a);
  xtWriteLn(t,'pass '+b);
  xtWriteLn(t,'binary');
  if (xOpen(f,downloadedFile,xGenFilMod_rw)=0) then begin;
    p:=xFileSize(f);
    xClose(f);
    end else p:=0;
  xtWriteLn(t,'restart '+BStr(p));
  if isThisDir then begin;
    c:=copy(c,1,length(c)-1);
    if (c<>'') then xtWriteLn(t,'cd '+c);
    xtWriteLn(t,'dir2 '+downloadedFile);
    end else begin;
    xtWriteLn(t,'get2 '+dataPath+TemporaryUrls+' '+downloadedFile);
    end;
  xtWriteLn(t,'quit');
  xtClose(t);
  xExec(myFavoritFtpClnt,dataPath+TemporaryCmds,w);
  decodingMethod:=2;
  if isThisDir then exit;
  a:=getDownExt;
  decodingMethod:=3;
  if (pos(a,fileExtBin)<>0) then decodingMethod:=4;
  if (pos(a,fileExtHtm)<>0) then decodingMethod:=1;
  exit;
  end;
if (a='gopher') then begin;
  if (currentPrx<>'') then begin; downloadMethod:=0;goto f1; end;
  downloadedFile:=fn;
  a:=dataPath+TemporaryCmds;
  xErase(a);
  xCreate(a);
  if (xtOpen(t,a,false)<>0) then immErr('error opening file!');
  i:=pos(':',currentUrl);
  a:=copy(currentUrl,i+3,666);
  i:=pos('/',a);
  if (i<1) then i:=666;
  b:=copy(a,1,i-1);
  c:=copy(a,i+1,666);
  a:=collectPort(b);
  xtWriteLn(t,'connect '+a+b);
  i:=pos('?',c);
  if (i>0) then begin;
    xtWriteLn(t,'param '+copy(c,i+1,666));
    c:=copy(c,1,i-1);
    end;
  if (c<>'') then c:=' '+c;
  xtWriteLn(t,'get2 '+downloadedFile+c);
  xtWriteLn(t,'quit');
  xtClose(t);
  xExec(myFavoritGopherClnt,dataPath+TemporaryCmds,w);
  decodingMethod:=9;
  if isThisDir then exit;
  a:=getDownExt;
  if (pos(a,fileExtBin)<>0) then decodingMethod:=4;
  if (pos(a,fileExtTxt)<>0) then decodingMethod:=3;
  if (pos(a,fileExtHtm)<>0) then decodingMethod:=1;
  exit;
  end;
if (a='file') then begin;
  decodingMethod:=5;
  if isThisDir then exit;
  downloadedFile:=getDownFile;
  a:=getDownExt;
  decodingMethod:=4;
  if (pos(a,fileExtTxt)<>0) then decodingMethod:=3;
  if (pos(a,fileExtHtm)<>0) then decodingMethod:=1;
  exit;
  end;
if (a='about') then begin;
  a:=kicsi(copy(currentUrl,o+3,666));
  if (a='bookmark') then begin; decodingMethod:=6;downloadedFile:=dataPath+BookmarkFileName; end;
  if (a='history') then begin; decodingMethod:=7;downloadedFile:=dataPath+HistoryFileName; end;
  if (a='about') then decodingMethod:=8;
  exit;
  end;
End;
